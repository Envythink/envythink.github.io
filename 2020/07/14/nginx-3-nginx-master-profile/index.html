<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Nginx主配置文件 | 余思博客</title><meta name="description" content="Nginx主配置文件"><meta name="keywords" content="nginx"><meta name="author" content="余思"><meta name="copyright" content="余思"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nginx主配置文件"><meta name="twitter:description" content="Nginx主配置文件"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="Nginx主配置文件"><meta property="og:url" content="http://envyzhan.top/2020/07/14/nginx-3-nginx-master-profile/"><meta property="og:site_name" content="余思博客"><meta property="og:description" content="Nginx主配置文件"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://envyzhan.top/2020/07/14/nginx-3-nginx-master-profile/"><link rel="prev" title="Nginx虚拟主机" href="http://envyzhan.top/2020/07/16/nginx-4-nginx-virtual-host/"><link rel="next" title="Nginx安装和功能模块介绍" href="http://envyzhan.top/2020/07/12/nginx-2-nginx-installation-and-function-module-introduction/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://envythink.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: 余思","link":"链接: http://envyzhan.top/2020/07/14/nginx-3-nginx-master-profile/","source":"来源: 余思博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">余思博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-html5" aria-hidden="true"></i><span> 前端</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> Java</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 运维</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 中间件</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page" href="/categories/nginx/"><i class="fa-fw fa fa-location-arrow"></i><span> Nginx</span></a></li><li><a class="site-page" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bell" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 数据结构</span></a></li><li><a class="site-page" href="/categories/algorithm/"><i class="fa-fw fa fa-plane"></i><span> 算法建模</span></a></li><li><a class="site-page" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-address-book" aria-hidden="true"></i><span> 生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">213</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">15</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-html5" aria-hidden="true"></i><span> 前端</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> Java</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 运维</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 中间件</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page" href="/categories/nginx/"><i class="fa-fw fa fa-location-arrow"></i><span> Nginx</span></a></li><li><a class="site-page" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bell" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 数据结构</span></a></li><li><a class="site-page" href="/categories/algorithm/"><i class="fa-fw fa fa-plane"></i><span> 算法建模</span></a></li><li><a class="site-page" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-address-book" aria-hidden="true"></i><span> 生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#写在前面"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">写在前面</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Nginx配置文件"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">Nginx配置文件</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#常用正则介绍"><span class="toc_mobile_items-number">2.0.1.</span> <span class="toc_mobile_items-text">常用正则介绍</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#全局变量"><span class="toc_mobile_items-number">2.0.2.</span> <span class="toc_mobile_items-text">全局变量</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#预定义变量"><span class="toc_mobile_items-number">2.0.3.</span> <span class="toc_mobile_items-text">预定义变量</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#main模块"><span class="toc_mobile_items-number">2.0.4.</span> <span class="toc_mobile_items-text">main模块</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#events模块"><span class="toc_mobile_items-number">2.0.5.</span> <span class="toc_mobile_items-text">events模块</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#http模块"><span class="toc_mobile_items-number">2.0.6.</span> <span class="toc_mobile_items-text">http模块</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#server模块"><span class="toc_mobile_items-number">2.0.7.</span> <span class="toc_mobile_items-text">server模块</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#location模块"><span class="toc_mobile_items-number">2.0.8.</span> <span class="toc_mobile_items-text">location模块</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#upstream模块"><span class="toc_mobile_items-number">2.0.9.</span> <span class="toc_mobile_items-text">upstream模块</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#完整配置文件示例"><span class="toc_mobile_items-number">2.0.10.</span> <span class="toc_mobile_items-text">完整配置文件示例</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#写在前面"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx配置文件"><span class="toc-number">2.</span> <span class="toc-text">Nginx配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#常用正则介绍"><span class="toc-number">2.0.1.</span> <span class="toc-text">常用正则介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全局变量"><span class="toc-number">2.0.2.</span> <span class="toc-text">全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#预定义变量"><span class="toc-number">2.0.3.</span> <span class="toc-text">预定义变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main模块"><span class="toc-number">2.0.4.</span> <span class="toc-text">main模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#events模块"><span class="toc-number">2.0.5.</span> <span class="toc-text">events模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http模块"><span class="toc-number">2.0.6.</span> <span class="toc-text">http模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server模块"><span class="toc-number">2.0.7.</span> <span class="toc-text">server模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#location模块"><span class="toc-number">2.0.8.</span> <span class="toc-text">location模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upstream模块"><span class="toc-number">2.0.9.</span> <span class="toc-text">upstream模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#完整配置文件示例"><span class="toc-number">2.0.10.</span> <span class="toc-text">完整配置文件示例</span></a></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Nginx主配置文件</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-07-14</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/nginx/">nginx</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">3.8k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 13 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2020/07/14/nginx-3-nginx-master-profile/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>考虑到Nginx主配置文件的重要性和日常使用的高频率，这里专门拿出一篇文章来深入学习nginx.conf主配置文件，灵活配置nginx.conf主配置文件是学好Nginx的关键所在。</p>
<h1 id="Nginx配置文件"><a href="#Nginx配置文件" class="headerlink" title="Nginx配置文件"></a>Nginx配置文件</h1><p>在nginx目录下有一个conf目录，里面存放的都是与Nginx配置相关的文件，一般来说我们修改的都是名为nginx.conf的主配置文件。该配置文件由若干个部分组成，每个大括号<code>{}</code>表示一个部分，每行指令都由分号结束<code>;</code>，用于表示一行的结束。<br>去除nginx.conf主配置文件中的注释代码，完整的内容如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">events {</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">http {</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    server {</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location / {</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html {</span><br><span class="line">            root   html;</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>
<p>使用类似于tree的命令来生成该配置文件内容的树形图，如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">main        # 全局配置，对全局生效</span><br><span class="line">├── events  # 配置影响Nginx服务器或与用户的网络连接（项工作模式设置）</span><br><span class="line">├── http    # 配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置（http设置）</span><br><span class="line">│   ├── upstream # 配置后端服务器具体地址，需要使用负载均衡时必须配置（负载均衡设置）</span><br><span class="line">│   ├── server   # 配置虚拟主机的相关参数，一个http块中可以有多个server块（主机设置）</span><br><span class="line">│   ├── server</span><br><span class="line">│   │   ├── location  # server块可以包含多个location块，location指令用于匹配uri（URL设置）</span><br><span class="line">│   │   ├── location</span><br><span class="line">│   │   └── ...</span><br><span class="line">│   └── ...</span><br><span class="line">└── ...</span><br></pre></td></tr></tbody></table></figure></div>
<p>先从整体层面来学习这个Nginx配置文件，通常的配置语法规则如下：<br>（1）配置文件由指令和指令块构成；<br>（2）每条指令以<code>;</code>分号结尾，指令与参数间以空格符号分隔；<br>（3）指令块与<code>{}</code>大括号将多余条指令组织在一起；<br>（4）include语句允许组合多个配置文件以提升可维护性；<br>（5）使用<code>#</code>符号添加注释，提高可读性；<br>（6）使用<code>$</code>符号使用变量；<br>（7）部分指令的参数支持正则表达式。</p>
<h3 id="常用正则介绍"><a href="#常用正则介绍" class="headerlink" title="常用正则介绍"></a>常用正则介绍</h3><p>从上面的介绍中可以看到，server块中可以包含多个location块，location指令用于匹配uri，语法如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location [ = | ^~ | ~ | ~* ] uri {</span><br><span class="line">	...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>简单解释一下上述代码的含义：location是指令；<code>[ = | ^~ | ~ | ~* ]</code>是匹配的标识符；uri是匹配的网站地址；<code>{...}</code>是匹配URI后要执行的配置段。</p>
<p>这里对指令后面匹配的标识符进行介绍，如下：<br>（1）<code>=</code>精确匹配路径，用于不包含正则表达式的uri前，如果匹配成功，那么就不再进行后续的查找；<br>（2）<code>^~</code>用于不包含正则表达式的uri前，表示如果该符号后面的字符是最佳匹配，则采用该规则，不再进行后续的查找。</p>
<hr>
<p>（3）<code>~</code>表示用该符号后面的正则去匹配路径，<strong>区分大小写</strong>；<br>（4）<code>~*</code>表示用该符号后面的正则去匹配路径，<strong>不区分大小写</strong>；<br>（5）<code>/</code>是通用匹配，任何请求都会匹配到。</p>
<p>也就是说如果uri中不包含正则表达式，则可以使用前面两个；如果包含则必须使用后面两个。</p>
<p>当然常用的正则如下表所示：<br>正则|说明|<br>-|:-:|<br><code>.</code>|匹配除换行符以外的任意字符|<br><code>?</code>|匹配0次或者1次|<br><code>+</code>|匹配1次或者多次|<br><code>*</code>|匹配0次或者多次|<br><code>\d</code>|匹配数字，即0-9|<br><code>\D</code>|匹配非数字，即不是数字|<br><code>^</code>|匹配字符串的开始|<br><code>$</code>|匹配字符串的结束|<br><code>{n}</code>|重复n次|<br><code>{n,}</code>|重复n次或多次|<br><code>[c]</code>|匹配单个字符c|<br><code>[a-z]</code>|匹配a-z小写字母中的任意一个|</p>
<p>由于location后面的标识符非常重要，后续会专门出一篇文章来研究它的用法。</p>
<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><p>当然除了可以使用正则表达式外，还可以使用一些常用的全局变量，开发者可以在配置的任意位置使用它们：</p>
<table>
<thead>
<tr>
<th>全局变量名</th>
<th align="center">功能介绍</th>
</tr>
</thead>
<tbody><tr>
<td><code>$host</code></td>
<td align="center">请求信息中的Host，如果请求中没有Host行，则等于设置的服务器名，注意不包括端口</td>
</tr>
<tr>
<td><code>$request_method</code></td>
<td align="center">客户端请求类型，如 GET、POST</td>
</tr>
<tr>
<td><code>$args</code></td>
<td align="center">请求中的参数</td>
</tr>
<tr>
<td><code>$arg_PARAMETER</code></td>
<td align="center">GET 请求中变量名PARAMETER参数的值，如$http_user_agent就表示User-Agent 的值</td>
</tr>
<tr>
<td><code>$content_length</code></td>
<td align="center">请求头中的Content-length字段的值</td>
</tr>
<tr>
<td><code>$content_type</code></td>
<td align="center">请求头中的Content-Type字段的值</td>
</tr>
<tr>
<td><code>$http_user_agent</code></td>
<td align="center">客户端agent信息</td>
</tr>
<tr>
<td><code>$http_cookie</code></td>
<td align="center">客户端cookie信息</td>
</tr>
<tr>
<td><code>$remote_addr</code></td>
<td align="center">客户端的IP地址</td>
</tr>
<tr>
<td><code>$remote_port</code></td>
<td align="center">客户端的端口</td>
</tr>
<tr>
<td><code>$remote_user</code></td>
<td align="center">已经经过Auth Basic Module验证过的用户名</td>
</tr>
<tr>
<td><code>$server_protocol</code></td>
<td align="center">请求使用的协议，如 HTTP/1.0、HTTP/1.1</td>
</tr>
<tr>
<td><code>$server_addr</code></td>
<td align="center">服务器地址</td>
</tr>
<tr>
<td><code>$server_name</code></td>
<td align="center">服务器名称</td>
</tr>
<tr>
<td><code>$server_port</code></td>
<td align="center">服务器的端口号</td>
</tr>
<tr>
<td><code>$scheme</code></td>
<td align="center">HTTP 方法（如http，https）</td>
</tr>
<tr>
<td><code>$uri</code></td>
<td align="center">不带请求参数的当前URI，注意<code>$uri</code>中不包含主机名，如/envy/index.html</td>
</tr>
<tr>
<td><code>$document_uri</code></td>
<td align="center">功能与<code>$uri</code>类似</td>
</tr>
<tr>
<td><code>$document_root</code></td>
<td align="center">当前请求在root指令中指定的值</td>
</tr>
<tr>
<td><code>$request_uri</code></td>
<td align="center">包含请求参数的原始URI，注意也不包含主机名，如/envy/search.html?name=envy</td>
</tr>
<tr>
<td><code>$request_filename</code></td>
<td align="center">当前请求的文件路径，由root或者alias指令与URI请求生成</td>
</tr>
<tr>
<td><code>$limit_rate</code></td>
<td align="center">用于限制连接速率</td>
</tr>
</tbody></table>
<p>举个例子，如请求<code>http://127.0.0.1:8080/envy/think/hello.html</code>，那么其中的部分信息如下：<br>全局变量名|内容|<br>-|:-:|<br><code>$host</code>|127.0.0.1|<br><code>$server_port</code>|8080|<br><code>$request_uri</code>|/envy/think/hello.html|<br><code>$document_uri</code>|/envy/think/hello.html|<br><code>$document_root</code>|/var/www/html|<br><code>$request_filename</code>|/var/www/html/envy/think/hello.html|</p>
<h3 id="预定义变量"><a href="#预定义变量" class="headerlink" title="预定义变量"></a>预定义变量</h3><p>除了全局变量，Nginx还提供了很多预定义的变量，开发者也可以通过set来设置变量，下面是一些常用的预定义变量，可以看到这些和全局变量其实差不多：</p>
<table>
<thead>
<tr>
<th>预变量名</th>
<th align="center">所表示的值</th>
</tr>
</thead>
<tbody><tr>
<td><code>$args_name</code></td>
<td align="center">请求中name参数的值</td>
</tr>
<tr>
<td><code>$args</code></td>
<td align="center">所有请求参数</td>
</tr>
<tr>
<td><code>$query_string</code></td>
<td align="center"><code>$args</code>的别名</td>
</tr>
<tr>
<td><code>$content_length</code></td>
<td align="center">请求头Content-Length的值</td>
</tr>
<tr>
<td><code>$content_type</code></td>
<td align="center">请求头Content-Type的值</td>
</tr>
<tr>
<td><code>$host</code></td>
<td align="center">如果当前有Host，那么为请求头Host的值；如果没有，那么该值等于匹配该请求的server_name的值</td>
</tr>
<tr>
<td><code>$remote_addr</code></td>
<td align="center">客户端的IP地址</td>
</tr>
<tr>
<td><code>$request</code></td>
<td align="center">客户端发起的完整请求，包括HTTP请求方法、URI、HTTP协议、头和请求体</td>
</tr>
<tr>
<td><code>$request_uri</code></td>
<td align="center">客户端发起的完整请求的URI，注意包括参数</td>
</tr>
<tr>
<td><code>$scheme</code></td>
<td align="center">当前请求的协议</td>
</tr>
<tr>
<td><code>$uri</code></td>
<td align="center">当前请求的标准化URI</td>
</tr>
</tbody></table>
<h3 id="main模块"><a href="#main模块" class="headerlink" title="main模块"></a>main模块</h3><p>全局设置填写Nginx的全局配置，在此区域填写的内容会被应用到Nginx的全局，如修改Nginx默认的用户名（默认为nobody）可以在配置文件的开头加上user nginx，这样Nginx运行的用户就变成了nginx。</p>
<p>常用的全局配置项如下：<br>（1）<code>worker_processes</code>，表示Nginx开启的子进程数；<br>（2）<code>error_log</code>，表示定义全局错误日志文件，可选的值有debug、info、notice、warn、error、crit等；<br>（3）<code>pid</code>用于指定进程id的存储文件位置；<br>（4）<code>worker_rlimit_nofile</code>，用于指定Nginx进程最多可以打开的文件描述符数目。</p>
<p>举个例子，如下所示的配置信息：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 定义Nginx运行的用户和用户组</span><br><span class="line">user nginx nginx;</span><br><span class="line"></span><br><span class="line"># Nginx进程数，一般建议为CPU的总核心数，或者设置为auto</span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line"># 定义全局错误日志类型</span><br><span class="line">error_log /var/log/nginx/error.log info;</span><br><span class="line"></span><br><span class="line"># 进程文件</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"># 一个Nginx进程最多可以打开的文件描述符数目，建议与ulimit -n的值保持一致</span><br><span class="line">worker_rlimit_nofile 65536;</span><br></pre></td></tr></tbody></table></figure></div>
<p>上面的例子只是为了示例，在实际使用工作中可以使用默认的配置，也就是不用作任何修改。</p>
<h3 id="events模块"><a href="#events模块" class="headerlink" title="events模块"></a>events模块</h3><p>events模块用来指定Nginx的工作模式和单个进程的连接数上限。举个例子如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">events {</span><br><span class="line">    # 参考事件模型，可选值有kqueue、rtsig、epoll、/dev/poll、select、poll</span><br><span class="line">    # epoll是linux2.6以上版本内核中的高性能网络I/O模型</span><br><span class="line">    # FreeBSD或者macOS可以使用kqueue模型</span><br><span class="line">    use epoll;</span><br><span class="line"></span><br><span class="line">    # 单个进程的最大连接数（默认是1024，最大连接数=连接数*进程数）</span><br><span class="line">    worker_connections  65535;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>上述进程的最大连接数受Linux系统进程的最大打开文件数的限制，只有在执行操作系统命令<code>ulimit -n 65536</code>之后worker_connections的设置才会生效。</p>
<h3 id="http模块"><a href="#http模块" class="headerlink" title="http模块"></a>http模块</h3><p>http部分是配置文件最核心的部分，它包括了绝大部分HTTP服务器相关属性的配置，如是否使用Keepalive，是否使用gzip进行压缩等，还包括server和upstream这些子模块，这些都是Nginx负载均衡的重要配置部分。</p>
<p>举个例子，下面是较为完整的配置信息：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># 配置http服务器</span><br><span class="line">http {</span><br><span class="line">  # 文件扩展名与文件类型映射表</span><br><span class="line">  include mime.types;</span><br><span class="line">  # 默认文件类型</span><br><span class="line">  default_type application/octet-stream;</span><br><span class="line">  # 默认编码</span><br><span class="line">  charset utf-8;</span><br><span class="line">  # 服务器名字的hash表大小</span><br><span class="line">  server_names_hash_bucket_size 128;</span><br><span class="line">  # 缓冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">  client_body_buffer_size 128k;</span><br><span class="line">  # 允许客户端请求的最大单文件字节数</span><br><span class="line">  client_max_body_size 10m;</span><br><span class="line">  # 开启高效文件传输模式，启用之后Nginx会调用sendfile函数来输出文件</span><br><span class="line">  # I/O负载较大的应用，建议设置为off，以平衡磁盘与网络I/O处理速度，减少系统的负载</span><br><span class="line">  sendfile on;</span><br><span class="line">  #开启目录列表访问（默认关闭）</span><br><span class="line">  autoindex on;</span><br><span class="line">  # 防止网络阻塞</span><br><span class="line">  tcp_nopush on;</span><br><span class="line">  tcp_nodelay on;</span><br><span class="line">  # 长连接超时的时间，单位为秒</span><br><span class="line">  keepalive_timeout 120;</span><br><span class="line">  </span><br><span class="line">  # gzip模块设置</span><br><span class="line">  # 开启gzip压缩输出</span><br><span class="line">  gzip on;</span><br><span class="line">  # 最小压缩文件的大小</span><br><span class="line">  gzip_min_length 1k;</span><br><span class="line">  # 压缩缓冲区</span><br><span class="line">  gzip_buffers 4 16k;</span><br><span class="line">  # 压缩版本</span><br><span class="line">  gzip_http_version 1.1;</span><br><span class="line">  # 压缩等级</span><br><span class="line">  gzip_comp_level 2;</span><br><span class="line">  # 压缩类型，默认已经包括text/html，因此下面的就可以不用写了</span><br><span class="line">  gzip_types text/plain application/x-javascript text/css application/xml;</span><br><span class="line">  # 下面的设置会在响应头上加个Vary：Accept-Encoding，可以让前端的缓存服务器经过gzip压缩的页面</span><br><span class="line">  gzip_vary on;</span><br><span class="line">  # 在开启限制IP连接数的时候需要使用下面的配置</span><br><span class="line">  limit_zone crawler $binary_remote_addr 10m;</span><br><span class="line"></span><br><span class="line">  upstream peoject_name {</span><br><span class="line">    ......</span><br><span class="line">  }</span><br><span class="line">  server {</span><br><span class="line">    ......</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>http模块的设置非常庞杂，这里只是列举一小部分配置。</p>
<h3 id="server模块"><a href="#server模块" class="headerlink" title="server模块"></a>server模块</h3><p>server模块是http的子模块，它可以定义一个虚拟主机，基本配置如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server {</span><br><span class="line">  listen 2222;</span><br><span class="line">  server_name localhost 1.1.1.1 www.example.com;</span><br><span class="line">  root /nginx/www/path/;</span><br><span class="line">  index index.php index.html index.htm;</span><br><span class="line">  charset utf-8;</span><br><span class="line">  access_log usr/local/var/log/host.access.log main;</span><br><span class="line">  aerror_log usr/local/var/log/host.error.log error;</span><br><span class="line">  ......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>简单解释一下上述配置信息内容：<br>（1）<code>server{}</code>表示虚拟主机配置范围；<br>（2）listen用于指定虚拟主机的服务端口；<br>（3）server_name用于指定IP地址或者域名，在多个域名之间用空格分开；<br>（4）root表示在server这个虚拟主机内Web服务的根目录；<br>（5）index用于定义默认的首页地址；<br>（6）charset用于设置网页的默认编码格式；<br>（7）access_log用于指定虚拟主机访问日志的存放路径，后面接上日志的输出格式。</p>
<p>server模块的配置也很多，其中location模块也是server模块的子模块。</p>
<h3 id="location模块"><a href="#location模块" class="headerlink" title="location模块"></a>location模块</h3><p>location模块是Nginx中可自定义程度最高的模块，它用于定位解析URL，通过使用正则匹配，用户可以通过location指令实现对网页的各种处理。</p>
<p>举个例子，下面这个反向代理中的<code>location /</code>就是用于匹配根目录：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / {</span><br><span class="line">  root /nginx/www/path;</span><br><span class="line">  index index.php index.html index.htm;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h3 id="upstream模块"><a href="#upstream模块" class="headerlink" title="upstream模块"></a>upstream模块</h3><p>upstream模块又称为负载均衡模块，下面通过一个简单的调度算法来认识这个模块：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">upstream example.com {</span><br><span class="line">  fair;</span><br><span class="line">  server 192.168.73.1:80;</span><br><span class="line">  server 192.168.73.2:8080 down;</span><br><span class="line">  server 192.168.73.3:6666 max_fails=3 fail_timeout=20s max_conns=1000;</span><br><span class="line">  server 192.168.73.4:3333 backup;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>在上面的例子中，通过使用upstream指令定义了一个名为example.com的负载均衡器，此处的名称可以随意指定，不一定是一个域名。其中的fair是一种负载均衡调度算法，后面的server表示真实服务器群组，后接真实服务器的IP地址。</p>
<p>请注意IP地址后面的down表示该server不参与负载均衡；backup表示预留的备份机器，只有当其他所有的非backup机器出现故障或者异常忙碌时，才会请求backup机器，所有这台机器的负载压力较小；max_fails表示允许请求失败的次数（默认为1次），当超过最大次数时返回proxy_next_upstream模块定义的错误。fail_timeout表示在经历max_fails次失败后暂停服务的时间。max_conns表示限制分配给后端服务器处理的最大连接数量，超过这个数量，将不会分配新的连接给它。</p>
<p>请注意，upstream模块中还有一个resolve选项，它需要配合http模块来使用，如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http {</span><br><span class="line">  resolver 192.168.73.100</span><br><span class="line">  upstream u {</span><br><span class="line">    ......</span><br><span class="line">    server example.com resolve;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>在http模块下配置resolver命令，指定域名解析服务为example.com域名，并且由192.168.73.100服务器来负责解析。关于upstream模块的常见配置，可以点击 <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank" rel="noopener">这里</a> 进行查阅。</p>
<p>下面用一张图来对nginx.conf主配置文件的内容进行总结：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-49f2c7445ceaba4b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title class="mediumZoom lazyload" data-src="https://upload-images.jianshu.io/upload_images/8964398-49f2c7445ceaba4b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></a></p>
<h3 id="完整配置文件示例"><a href="#完整配置文件示例" class="headerlink" title="完整配置文件示例"></a>完整配置文件示例</h3><p>下面是一个较为完整的配置文件示例，内容如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">user  nginx nginx;         # 运行用户和组，默认是nginx，可不进行设置</span><br><span class="line">worker_processes  1;      # Nginx 进程数，一般设置为CPU核数或者设置为auto</span><br><span class="line">error_log  /var/log/nginx/error.log warn;   # 定义全局Nginx错误日志存放目录及类型</span><br><span class="line">pid    /var/run/nginx.pid;      # Nginx服务启动时pid的存放位置</span><br><span class="line">worker_rlimit_nofile 65536;   # 一个Nginx进程最多可以打开的文件描述符数目，建议与ulimit -n的值保持一致</span><br><span class="line"></span><br><span class="line">events {</span><br><span class="line">    use epoll;     # 使用epoll这一I/O模型</span><br><span class="line">    worker_connections 65535;    # 单个进程的最大连接数（默认是1024，最大连接数=连接数*进程数）</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">http {   # 配置使用最频繁的部分，代理、缓存、日志定义等绝大多数功能和第三方模块的配置都在这里设置</span><br><span class="line">    # 设置日志模式</span><br><span class="line">    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;   # Nginx访问日志存放位置</span><br><span class="line"></span><br><span class="line">    sendfile            on;   # 开启高效传输模式</span><br><span class="line">    tcp_nopush          on;   # 减少网络报文段的数量</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;   # 保持连接的时间，也称超时时间，单位秒</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;      # 文件扩展名与类型映射表</span><br><span class="line">    default_type        application/octet-stream;   # 默认文件类型</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;   # 加载子配置项</span><br><span class="line">    </span><br><span class="line">    server {</span><br><span class="line">    	listen       80;       # 配置监听的端口</span><br><span class="line">    	server_name  localhost;    # 配置的域名</span><br><span class="line">    	</span><br><span class="line">    	location / {</span><br><span class="line">    		root   /usr/share/nginx/html;  # 网站根目录</span><br><span class="line">    		index  index.html index.htm;   # 默认首页文件</span><br><span class="line">    		deny 192.168.73.10;   # 禁止访问的ip地址，可以为all</span><br><span class="line">    		allow 192.168.73.18；# 允许访问的ip地址，可以为all</span><br><span class="line">    	}</span><br><span class="line">    	</span><br><span class="line">    	error_page 500 502 503 504 /50x.html;  # 默认50x对应的访问页面</span><br><span class="line">    	error_page 400 404 error.html;   # 默认40x对应的访问页面</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>也就是说整个Nginx的核心配置文件的框架为：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line">events {</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">}</span><br><span class="line">http {</span><br><span class="line">    include       mime.types;</span><br><span class="line">    server {</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / {</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>这样关于Nginx安装和配置文件的介绍就先学习到这。</p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">余思</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://envyzhan.top/2020/07/14/nginx-3-nginx-master-profile/">http://envyzhan.top/2020/07/14/nginx-3-nginx-master-profile/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://envyzhan.top">余思博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nginx/">nginx    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/07/16/nginx-4-nginx-virtual-host/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Nginx虚拟主机</span></div></a></div><div class="next-post pull_right"><a href="/2020/07/12/nginx-2-nginx-installation-and-function-module-introduction/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Nginx安装和功能模块介绍</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/08/10/nginx-14-ssl-configuration-and-pan-domain-name-and-static-service/" title="SSL配置、泛域名和静态服务"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">SSL配置、泛域名和静态服务</div></div></a></div><div class="relatedPosts_item"><a href="/2020/08/08/nginx-13-nginx-running-state-and-nginx-web-ui/" title="Nginx运行状态和NginxWebUI"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Nginx运行状态和NginxWebUI</div></div></a></div><div class="relatedPosts_item"><a href="/2020/08/05/nginx-12-file-access-control-and-structure-optimization-and-mobile-adaptation/" title="Nginx文件访问控制、结构优化和适配移动端"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Nginx文件访问控制、结构优化和适配移动端</div></div></a></div><div class="relatedPosts_item"><a href="/2020/08/01/nginx-11-security-chain-and-crawler-and-virtual-directory/" title="Nginx防盗链、爬虫和虚拟目录"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Nginx防盗链、爬虫和虚拟目录</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/30/nginx-10-security-optimization/" title="Nginx安全优化"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Nginx安全优化</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/28/nginx-9-log-file/" title="Nginx日志文件"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Nginx日志文件</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '9996b44b488f2fc52124',
  clientSecret: '6bec0f8e9c032eeae6211a5d4cffa3c97e2d4a64',
  repo: 'blogcomment',
  owner: 'Envythink',
  admin: 'Envythink',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
}</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">Copyright &copy;2017-2021 余思博客, 版权所有</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/fireworks.js"></script><script src="/js/tw_cn.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>