<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CICD平台搭建：Ansible playbooks介绍 | 余思博客</title><meta name="keywords" content="cicd"><meta name="author" content="余思"><meta name="copyright" content="余思"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="将下来介绍Ansible playbooks的相关知识，之前你已经在本地安装了ansible，现在就是如何编写脚本让ansible发挥作用。 playbook语言介绍playbook作为ansible独有的术语，是ansible配置部署的编排语言框架，本身简单易读的语法结构以及丰富的内嵌模块非常易于我们编写远程系统部署策略，playbook基础的文件格式为yaml格式，可以将playbook称之为">
<meta property="og:type" content="article">
<meta property="og:title" content="CICD平台搭建：Ansible playbooks介绍">
<meta property="og:url" content="http://envyzhan.asia/2020/01/11/devops-cicd-4-ansbile-playbook-introdution/index.html">
<meta property="og:site_name" content="余思博客">
<meta property="og:description" content="将下来介绍Ansible playbooks的相关知识，之前你已经在本地安装了ansible，现在就是如何编写脚本让ansible发挥作用。 playbook语言介绍playbook作为ansible独有的术语，是ansible配置部署的编排语言框架，本身简单易读的语法结构以及丰富的内嵌模块非常易于我们编写远程系统部署策略，playbook基础的文件格式为yaml格式，可以将playbook称之为">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png">
<meta property="article:published_time" content="2020-01-11T07:45:10.000Z">
<meta property="article:modified_time" content="2020-11-01T14:39:06.742Z">
<meta property="article:author" content="余思">
<meta property="article:tag" content="cicd">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://envyzhan.asia/2020/01/11/devops-cicd-4-ansbile-playbook-introdution/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CICD平台搭建：Ansible playbooks介绍',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-11-01 22:39:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="余思博客" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">249</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 前端</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page child" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page child" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li><li><a class="site-page child" href="/categories/flutter/"><i class="fa-fw fa fa-bullseye"></i><span> Flutter</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> Java</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page child" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page child" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page child" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page child" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 运维</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page child" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page child" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 中间件</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page child" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li><li><a class="site-page child" href="/categories/other/"><i class="fa-fw fa fa-location-arrow"></i><span> 其他</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bell"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 算法结构</span></a></li><li><a class="site-page child" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-address-book"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">余思博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 前端</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page child" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page child" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li><li><a class="site-page child" href="/categories/flutter/"><i class="fa-fw fa fa-bullseye"></i><span> Flutter</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> Java</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page child" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page child" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page child" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page child" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 运维</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page child" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page child" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 中间件</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page child" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li><li><a class="site-page child" href="/categories/other/"><i class="fa-fw fa fa-location-arrow"></i><span> 其他</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bell"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 算法结构</span></a></li><li><a class="site-page child" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-address-book"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CICD平台搭建：Ansible playbooks介绍</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-01-11T07:45:10.000Z" title="发表于 2020-01-11 15:45:10">2020-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-11-01T14:39:06.742Z" title="更新于 2020-11-01 22:39:06">2020-11-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/devops/">devops</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>将下来介绍Ansible playbooks的相关知识，之前你已经在本地安装了ansible，现在就是如何编写脚本让ansible发挥作用。</p>
<h1 id="playbook语言介绍"><a href="#playbook语言介绍" class="headerlink" title="playbook语言介绍"></a>playbook语言介绍</h1><p>playbook作为ansible独有的术语，是ansible配置部署的编排语言框架，本身简单易读的语法结构以及丰富的内嵌模块非常易于我们编写远程系统部署策略，playbook基础的文件格式为yaml格式，可以将playbook称之为总的乐谱，每一个yaml文件可以称为一个playbook的乐章，在这个playbook下可以编写一个或多个task作为这个乐章的音符。我们通过ansible相关的命令去play演奏这个乐谱，就可以将我们预先写好的任务，按照特定的编排部署到远程服务器当中，也就是演奏给我们的听众听。</p>
<p>接下来将详细说明及通过demo演示的方式，向大家介绍一个基础playbooks的框架格式与编写规范。这里通过引入一个Test playbooks乐谱作为一个例子，进行逐一介绍它的基础框架和格式。下面是它的总文件结构：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/8964398-89064740f2c4e0ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>inventory目录、roles目录及deploy.yml文件构成了它的表层目录结构。下面就详细介绍各个目录的作用。</p>
<p><strong>inventory目录</strong>下可以存放一个或多个server详细清单目录，用来保存目标部署主机的相关域名或者IP地址，以及该主机的变量参数。通常可以用具体的部署环境例如develpoy开发环境，uat单元测试环境或者production最终产品环境，用来给server清单命名，对应保存在清单的主机地址具体部署到哪个环境当中。</p>
<p><strong>inventory/testenv文件</strong>，是具体清单与变量声明文件，这里是保存<code>inventory/testenv</code>文件，意在保存在testenv下的主机部署到testenv环境当中。</p>
<p><strong>roles目录</strong>，是任务列表，保存需要部署的详细任务列表，里面可以存放一个或者多个role，通常命名为具体的add或者项目名称。</p>
<p><strong>roles/testbox目录</strong> ，是testbox详细任务，这里是将testbox作为项目名称。</p>
<p><strong>roles/testbox/task目录</strong> ，用来保存testbox任务乐章文件<code>main.yml</code>。</p>
<p><strong>roles/testbox/task/main.yml</strong> ，是testbox主任务文件。</p>
<p><strong>deploy.yml文件</strong>，是一个关键性文件，用作playbook任务入口，调动roles下需要部署的项目，以及该项目下的所有任务，最终将任务部署到environment下定义的目标主机中。下面是各个目录的层级结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">inventory/ </span><br><span class="line">  testenv </span><br><span class="line">roles/ </span><br><span class="line">  testbox/</span><br><span class="line">    task/ </span><br><span class="line">      main.yml</span><br><span class="line">deploy.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/8964398-b15d517fdf77dc3c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<h1 id="playbooks编写规范"><a href="#playbooks编写规范" class="headerlink" title="playbooks编写规范"></a>playbooks编写规范</h1><p>接下来开始介绍playbooks的编写规范，学会playbooks的编写规范有助于我们日后开展工作方便和高效。</p>
<h3 id="详细目录testenv"><a href="#详细目录testenv" class="headerlink" title="详细目录testenv"></a>详细目录testenv</h3><p>首先介绍inventory目录下的testenv这个详细目录，它由上下两部分组成：<code>[testservers]</code>和<code>[testservers:vars] </code>。<code>[testservers]</code>是一个Server组列表，用来保存一个或多个目标主机、域名或IP地址。我们这里设置了<code>test.example.com</code>这个域名对应目标部署服务器主机名（也就是需要部署的目标主机的域名）。<code>[testservers:vars] </code>是Server组列表参数，用来定义改组下的远程主机用到的所有key/value参数键值对，作为server组的变量声明，这里设置了<code>server_name</code>为<code>test.example.com</code>，<code>user</code>为<code>root</code>，<code>output</code>为<code>/root/test.txt</code>，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[testservers]</span><br><span class="line">test.example.com </span><br><span class="line"></span><br><span class="line">[testservers:vars] </span><br><span class="line">server_name=test.example.com</span><br><span class="line">user=root    </span><br><span class="line">output=/root/test.txt</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-2f2abb6b7cae166d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">这两部分组合到一起就构成了我们testenv环境下的server清单。</span><br><span class="line"></span><br><span class="line">### 主任务文件main.yml</span><br><span class="line"></span><br><span class="line">主任务文件`main.yml`存在于`roles/testbox/task`目录下，它用来保存特定role下的需要执行的具体任务乐章，乐章会保存一个或多个task作为我们的音符，task一般由两部分组成：`任务名称`和`具体执行的任务`。其中`任务名称`用来定义task名称便于我们编写好task后，知道它是干什么用的。`具体执行的任务`通常是使用shell模块执行命令。任务执行调用ansible内嵌模块编排任务逻辑。</span><br><span class="line"></span><br><span class="line">我们这里是让shell语句执行一句话并保存到目标目录文件下（打印主机名和用户名到远程testbox主机），`&#123;&#123;user&#125;&#125; 和&#123;&#123;server_name&#125;&#125;`引用了ansible的变量调用，将`inventory/testenv`文件里给我们目标主机定义的参数引入到当前文件中，这里user的值为root，server_name为test.example.com，output值为/root/test.txt，最终的完整语句为：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>name: print server name and user to #任务名称<br>remote testbox<br>shell: “echo ‘Currently  is logining ‘&gt;“ <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-a1a22f288b578e01.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">### 任务入口文件deploy.yml</span><br><span class="line"></span><br><span class="line">`deploy.yml`作为我们的核心文件用来与`ansible-playbook`命令直接对话，将playbook下的所有编排内容展示给我们的ansible命令进行最终的play演奏，最后部署到对应的目标主机当中。</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>hosts:”testservers” # 对应于inventory/testenv文件下的[testservers]组列表，用来调用这个组列表下的目标主机，也就是需要部署的目标主机tes.texample.com<br>gather_facts:true #server基本信息，用来获取目标主机下的一些基本信息<br>remote_user:root #目标服务器系统用户指定，告诉ansible我们在目标主机下使用的是root用户权限进行所有的系统文件操作<br>roles:<ul>
<li>testbox #告诉进入roles/testbox任务目录，进行接下来的任务执行<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-5c52ece495f628e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">这样就介绍完了ansible playbooks的编写规范。</span><br><span class="line"></span><br><span class="line">### SSH免密码秘钥认证</span><br><span class="line"></span><br><span class="line">由于ansible是以SSH作为通信协议，为了保证正常的通信连接，我们需要配置ansible主机与目标主机进行秘钥认证，保证ansible无需密码即可访问目标主机并进行相应的部署操作。</span><br><span class="line"></span><br><span class="line">第一步，使用下面的命令在ansible服务器端创建ssh本地秘钥(ssh rsa秘钥格式的本地公钥与私钥的秘钥对)：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
ssh-keygen -t rsa  #创建秘钥<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">第二步，使用下面的命令在ansible服务器端建立与目标部署机器的秘钥认证(将ansible服务器端的公钥传送到目标部署机器上，实现ansible服务器端可以免密码访问目标部署机器的资源，从而进行ansible playbooks的部署工作)：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
ssh-copy-id -i /home/deploy/.ssh/id_rsa.pub <a href="mailto:&#114;&#111;&#x6f;&#x74;&#x40;&#x74;&#101;&#x73;&#x74;&#x2e;&#x65;&#x78;&#x61;&#x6d;&#112;&#108;&#101;&#46;&#x63;&#111;&#x6d;">&#114;&#111;&#x6f;&#x74;&#x40;&#x74;&#101;&#x73;&#x74;&#x2e;&#x65;&#x78;&#x61;&#x6d;&#112;&#108;&#101;&#46;&#x63;&#111;&#x6d;</a> #远程推送公钥<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 执行playbooks</span><br><span class="line"></span><br><span class="line">在完成SSH免密码秘钥认证之后，就可以使用ansible内建的`ansible-playbook`命令去play执行我们的test playbooks例子。可以执行下面的命令来启动playbooks：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
ansible-playbook -i inventory/testenv ./deploy.yml <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">其中的`inventory/testenv`这个相对路径对应testenv服务器清单下的`testservers`的值，也就是`test.example.com`服务器主机，`./deploy.yml`用来引入我们当前目录下的`deploy.yml任务入口文件`。这里已经引入了这个入口文件，就可以开启部署工作。</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-5418c388c05c9bd3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">至此已经介绍完了playbooks框架及其各个子文件的编写规范，接下来就开始通过demo来演示如何在我们的ansible主机下利用playbooks框架去部署我们的远程目标主机。</span><br><span class="line"></span><br><span class="line">### 通过demo演示test playbook框架实例</span><br><span class="line"></span><br><span class="line">准备好两台虚拟机，系统均为CentOS7，一台是之前安装过ansible的虚拟机，一台是测试用的机器，我们用它来作为目标机器。</span><br><span class="line"></span><br><span class="line">第一步，登录ansible虚拟机主机，且换换为deploy用户，并加载之前创建的python3.6虚拟环境`.py3-a2.5-env`，并在该环境下加载我们之前安装的ansible2.5版本，使用的命令为：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
[root@localhost ~]# su - deploy   #进入deploy虚拟环境<br>[deploy@localhost ~]$ source /home/deploy/.py3-a2.5-env/bin/activate  #加载虚拟环境<br>(.py3-a2.5-env) [deploy@localhost ~]$ source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q   #在虚拟环境下加载ansible2.5版本<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">第二步，使用`ansible-playbook --version`命令来验证ansible的加载效果：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
(.py3-a2.5-env) [deploy@localhost ~]$ ansible-playbook –version   #验证ansible加载效果<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">第三步，开始演示如何编写playbooks框架。在当前目录`/home/deploy`下使用`mkdir test_playbooks`命令新建一个`test_playbooks`目录，并进入该目录，然后在该目录下创建若干个子目录，从而搭建我们当前的playbooks框架：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
(.py3-a2.5-env) [deploy@localhost test_playbooks]$ mkdir inventory<br>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ mkdir roles<br>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ cd inventory<br>(.py3-a2.5-env) [deploy@localhost inventory]$ vi testenv<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">进入到testenv这个文件后，使用编辑模式往里面添加以下信息：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
[testservers]<br>test.example.com</li>
</ul>
</li>
</ul>
<p>[testservers:vars]<br>server_name=test.example.com<br>user=root<br>output=/root/test.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">保存退出后，继续执行以下命令：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost inventory]$ cd ..<br>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ls  #查看当前的文件信息 inventory  roles<br>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ cd roles<br>(.py3-a2.5-env) [deploy@localhost roles]$ mkdir testbox<br>(.py3-a2.5-env) [deploy@localhost roles]$ cd testbox/<br>(.py3-a2.5-env) [deploy@localhost testbox]$ mkdir tasks<br>(.py3-a2.5-env) [deploy@localhost testbox]$ cd tasks/<br>(.py3-a2.5-env) [deploy@localhost tasks]$ vi main.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">进入到`main.yml`这个文件后，使用编辑模式往里面添加以下信息（注意冒号后面都有空格，且name和shell需要对齐，即距离最左边两个字符）：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>name: Print server name and user to remote testbox<br>shell: “echo ‘Currently  is logining  ‘&gt;“<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">保存退出后，继续执行以下命令：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
(.py3-a2.5-env) [deploy@localhost tasks]$ pwd  # 查看当前的路径，/home/deploy/test_playbooks/roles/testbox/tasks<br>(.py3-a2.5-env) [deploy@localhost tasks]$ cd ../../../  # 返回到test_playbooks目录下<br>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ pwd   # 确认当前路径，/home/deploy/test_playbooks<br>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ vi deploy.yml<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">进入到`deploy.yml`这个文件后，使用编辑模式往里面添加以下信息（注意冒号后面都有空格，且name和shell需要对齐，即距离最左边两个字符）：</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>hosts: “testservers”  # -号是最左边，冒号后有个空格，定义目标主机<br>gather_facts: true  # 距离左端两个空格，获取目标主机的信息<br>remote_user: root  # 距离左端两个空格，使用root账户权限<br>roles:  # 距离左端两个空格 <ul>
<li>testbox  # -号距离最左边四个空格，用于进入roles目录下的testbox任务目录进行接下来的任务执行<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">保存退出后，继续执行以下命令：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
(.py3-a2.5-env) [deploy@localhost test_playbooks]$ tree .  # 查看当前目录的目录树结构<br>.<br>├── deploy.yml<br>├── inventory<br>│   └── testenv<br>└── roles<br>└── testbox<br>  └── tasks<pre><code>  └── main.yml
</code></pre>
</li>
</ul>
</li>
</ul>
<p>4 directories, 3 files</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">别看命令复杂，其实就是为了创建下图所示的目录结构及文件而已：</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-b15d517fdf77dc3c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">这样我们就成功创建了一个test playbooks的框架例子，但是在我们使用ansible执行这个playbook之前需要去配置ansible主机与目标主机的秘钥认证，保证ansible无需密码即可访问我们的目标主机进行相应的部署操作。</span><br><span class="line"></span><br><span class="line">第四步，在进行SSH免密码秘钥认证之前，我们需要在ansible主机下去创建一个我们目标主机的DNS记录。这里面我们需要输入`su - root`去返回root用户，接着使用`vim /etc/hosts`命令打开hosts配置文件，在里面添加以下信息（注意前面的IP是你待部署目标机器对应的IP，不是ansible虚拟机对应的IP）：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>192.168.2.132    test.example.com</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">保存退出后，以deploy用户登录，并返回到该deploy目录：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost ~]$</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">第五步，给depoly用户创建一个本地的SSH秘钥认证对，使用的命令为：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost ~]$ ssh-keygen -t rsa   # 之后一路回车即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-fc9110342eb858a3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">可以看到我们的公钥(`id_rsa.pub`)和私钥(`id_rsa`)都保存在`/home/deploy/.ssh/`目录下面。</span><br><span class="line"></span><br><span class="line">第六步，使用下面的命令去指定deploy用户的公钥和目标主机的用户名及IP：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost ~]$ ssh-copy-id -i /home/deploy/.ssh/id_rsa.pub <a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#64;&#x74;&#x65;&#115;&#x74;&#x2e;&#x65;&#120;&#x61;&#109;&#x70;&#108;&#101;&#46;&#x63;&#111;&#109;">&#x72;&#x6f;&#x6f;&#x74;&#64;&#x74;&#x65;&#115;&#x74;&#x2e;&#x65;&#120;&#x61;&#109;&#x70;&#108;&#101;&#46;&#x63;&#111;&#109;</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后选择yes，并输入目标主机root用户的密码，当出现下面的信息，则表示你已经成功的将ansible虚拟机deploy用户的公钥已经传输给了我们目标主机root用户的ssh目录下，这样我们就成功的建立了ansible主机与目标主机之间的ssh秘钥认证。</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-b9462261a6bcd1c0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">第七步，使用下面的命令来测试是否可以免密登录：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost ~]$ ssh <a href="mailto:&#x72;&#x6f;&#111;&#x74;&#64;&#x74;&#101;&#115;&#x74;&#x2e;&#101;&#120;&#x61;&#x6d;&#112;&#108;&#101;&#46;&#99;&#111;&#x6d;">&#x72;&#x6f;&#111;&#x74;&#64;&#x74;&#101;&#115;&#x74;&#x2e;&#101;&#120;&#x61;&#x6d;&#112;&#108;&#101;&#46;&#99;&#111;&#x6d;</a>  # 测试免密登录<br>[root@localhost ~]# exit  # 测试成功，退出测试主机，返回ansible主机<br>(.py3-a2.5-env) [deploy@localhost ~]$ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">第八步，开始执行任务。进入到`/home/deploy/test_playbooks`目录下，使用下面的命令去执行ansible playbooks 入口文件 ，从而完成我们部署到testenv环境的测试操作：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">出现下面的信息，则表明任务执行完成：</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-9986377eba5f4f3e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</p>
<p>PLAY [testservers]<br>TASK [Gathering Facts]<br>ok: [test.example.com]</p>
<p>TASK [testbox : Print server name and user to remote testbox]<br>changed: [test.example.com]</p>
<p>PLAY RECAP ***<br>test.example.com           : ok=2    changed=1    unreachable=0    failed=0  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">可以看到一共有2个任务，执行状态都为ok，其中一个任务的状态发送了改变，`unreachable=0`表示无法达到的值为0，也就是可以直接访问到目标主机；`failed=0`表示语法结构没有任何错误。</span><br><span class="line"></span><br><span class="line">当然你还可以使用`ssh root@test.example.com`登录到目标主机，然后使用下面的命令查看是否生成了test.txt文件，并输出test.txt文件的信息：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@localhost ~]# cat test.txt<br>Currently root is logining test.example.com </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这样我们就在这台ansible主机下编写的test playbooks成功的将我们的测试任务部署到我们的目标主机当中，实现了将我们的乐谱通过ansible play演奏给我们的听众。</span><br><span class="line"></span><br><span class="line"># ansible playbook常用模块</span><br><span class="line"></span><br><span class="line">在前面介绍了ansible playbook的编写规范，以及通过一个test palybooks例子演示了如何将测试任务部署到我们的目标主机中。接下来介绍ansible playbook几个日常生活中常用的模块，并通过demo演示如何将这些模块如何运用在playbooks当中。</span><br><span class="line"></span><br><span class="line">ansible模块是由ansible对特定部署脚本打包封装后的成品，可以利用该模块成品直接编写playbooks，这样就大大简化了日常工作中对部署脚本的编写逻辑，便于后期维护管理。模块都是由上半部分的任务命名和下半部分的任务语句构成。</span><br><span class="line"></span><br><span class="line">**1、File模块**：用于在目标主机创建文件或目录，并赋予其系统权限。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>name: create a file #定义任务名称<br>file: ‘path=/root/foot.txt state=touch mode=0755 owner=foo group=foo’<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`- name`用于定义任务名称为`create a file`，而后面的`file`用于声明任务语句调用的是file模块。`path=/root/foot.txt `表示我们需要在目标主机上创建`/root/foot.txt`文件的路径；`state=touch`定义我们需要创建一个文件；`mode=0755`表示我们需要给这个文件赋予0755权限；`owner=foo`表示该文件属主为foo用户，`group=foo`表示该文件文件属组为foo用户所在的foo组，这样就构成了一个file模块的ansible任务。</span><br><span class="line"></span><br><span class="line">****</span><br><span class="line"></span><br><span class="line">**2、Copy模块**：用于实现ansible服务端到目标主机的文件传送，同样可以对目的地传送文件进行系统权限配置。</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>name: copy a file #定义任务名称<br>copy: ‘remote_src=no src=roles/testbox/files/foo.sh dest=/root/foo.sh mode=0644 force=yes’<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`- name`用于定义任务名称为`copy a file`，而后面的`copy`用于声明任务语句调用的是copy模块。`remote_src=no`用于声明将源ansible主机中的文件传输到目标主机当中；`src=roles/testbox/files/foo.sh`用于声明源文件为这个路径的文件；`dest=/root/foo.sh`用于声明源文件上传至目标主机的位置为`/root/foo.sh`；`mode=0644`表示我们需要给当前文件赋予0644权限；`force=yes`用于定义copy任务强制执行，这样就构成了一个copy模块的ansible任务。</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">**3、Stat模块**：用于获取远程主机中某文件的状态信息，并将信息保存在一个环境变量下供随后使用。</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>name: check if foo.sh exists #检查这个文件是否存在在<br>stat: ‘path=/root/foo.sh’ #获取远程主机/root/foo.sh文件状态信息<br>register: script_stat<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`- name`用于定义任务名称为`check if foo.sh exists`，检查这个文件是否存在在，而后面的`stat`用于声明任务语句调用的是stat模块。`path=/root/foo.sh`用于定义当前需要获取的文件路径为`/root/foo.sh`，`register: script_stat`表示将stat获取的文件信息传送给`script_stat`这个变量，从而实现从获取文件信息到给变量赋值这样一个任务操作，这样就构成了一个stat模块的ansible任务。</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">**4、Debug模块**：用于打印语句到ansible执行输出，通常与stat模块和where语句配合使用，确认文件状态，也可以调用参数进行语句输出。</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>debug: msg=foo.sh exits  # 定义输出内容<br>when: script_stat.exists # 调用条件语句when去调用之前的script_stat变量从而判断foo.sh是否存在<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`- debug:msg`用于定义输出内容，而后面的`when:script_stat.exists`用于调用条件语句when去调用之前的`script_stat`变量从而判断foo.sh是否存在。两个部分合在一起用来判断如果foo.sh文件存在，就在ansible执行信息里打印一条`foo.sh exits`存在的语句，不存在则不打印，这样就构成了一个debug模块的ansible任务。</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">**5、command/shell模块**：用来执行Linux目标主机命令行，不过shell模块会调用Linux系统下的/bin/bash，因此可以使用系统环境变量、重定向变量符、及管道符等，但是command模块就不能使用这些shell的特定符号用法。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="command模块"><a href="#command模块" class="headerlink" title="command模块"></a>command模块</h1></li>
<li>name: run the script<br>command: “sh /root/foo.sh”</li>
</ul>
<h1 id="shell模块"><a href="#shell模块" class="headerlink" title="shell模块"></a>shell模块</h1><ul>
<li>name: run the script<br>shell: “echo ‘test’ &gt;/root/test.txt” #可以使用重定向符（推荐）<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">shell模块可以使用重定向符，因此推荐大家使用shell模块，这样就构成了一个`command/shell`模块的ansible任务。</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">**6、template模块**：用于实现ansible服务端到目标主机的jinja2模板传送。</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>name: write the nginx config file #编写一个nginx配置文件<br>template: src=roles/testbox/templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`- name`用于定义任务名称为`write the nginx config file`（编写一个nginx配置文件），而后面的`template`用于声明任务语句调用的是template模块。`src=roles/testbox/templates/nginx.conf.j2`表示源ansible主机模板文件路径为`roles/testbox/templates/nginx.conf.j2`；`dest=/etc/nginx/nginx.conf `表示传送至目标主机路径且重命名为`/etc/nginx/nginx.conf`，注意这个nginx.conf定义的变量参数会调用playbooks server清单里的参数，生成最终的nginx.conf文件，这样就构成了一个`template`模块的ansible任务。</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">**7、packaging模块**：`packaging模块`是一个广义的模块集，用于调用目标主机系统下的包管理工具（yum/apt）进行软件安装。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="CentOSs-RedHat系统"><a href="#CentOSs-RedHat系统" class="headerlink" title="CentOSs/RedHat系统"></a>CentOSs/RedHat系统</h1></li>
<li>name: ensure nginx is at the latest version #确保nginx为最新版本<br>yum: pkg=nginx state=latest  # yum声明调用的语句是yum模块</li>
</ul>
<h1 id="Debian-Ubuntu系统"><a href="#Debian-Ubuntu系统" class="headerlink" title="Debian/Ubuntu系统"></a>Debian/Ubuntu系统</h1><ul>
<li>name: ensure nginx is at the latest version<br>apt: pkg=nginx state=latest # apt声明调用的语句是apt模块<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">也就是说可以调用Linux发行版的包管理工具，并根据定义的安装包名称进行配置安装，常用这个模块去安装不同Linux下的http安装包。常用在centos系统下安装`nginx.rpm`格式安装包，以及在Ubuntu系统下通过apt模块下安装`nginx.deb`格式的安装包。</span><br><span class="line"></span><br><span class="line">`- name`用于定义任务名称为`ensure nginx is at the latest version`（确保nginx为最新版本），而后面的`yum`用于声明任务语句调用的是yum模块；`apt`用于声明任务语句调用的是apt模块。`pkg=nginx`表示要安装的为nginx安装包；`state=latest`表示设定安装的nginx为最新版本，这样就构成了一个`packaging`模块的ansible任务。</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">**8、service模块**：用于管理目标主机的INIT系统服务。通常会调用主机的`service `或者`systemctl`用于管理系统服务资源的停止、启动和状态检查。</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>name: start nginx service  # 启动nginx服务<br>service: name=nginx state=started<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`- name`用于定义任务名称为`start nginx service`（启动nginx服务），而后面的`service`用于声明任务语句调用的是service模块。`name=nginx`表示定义调用的服务为nginx；`state=started`表示将nginx服务做一个启动操作，这样就构成了一个`service`模块的ansible任务。注意它必须在安装完nginx以后才能进行该模块操作。</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">接下来会通过前面介绍的8个常用模块，来编写一个完整的ansible playbook脚本文件，实现ansible playbook常用模块的应用。下面就是即将编写的脚本文件中的全部信息：</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-cd6ee7ed293c476e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">### 通过demo演示ansible playbook常用模块</span><br><span class="line"></span><br><span class="line">首先需要打开ansible主机和模板主机，然后在ansible主机上依次执行下面的命令：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
[root@localhost ~]# su - deploy  #进入deploy虚拟环境<br>[deploy@localhost ~]$ source /home/deploy/.py3-a2.5-env/bin/activate   #加载虚拟环境<br>(.py3-a2.5-env) [deploy@localhost ~]$ source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q  # 在虚拟环境下加载ansible2.5版本<br>(.py3-a2.5-env) [deploy@localhost ~]$ ansible-playbook –version  # 验证ansible-playbook命令是否有效<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">接着登上待部署的目标机器上，进行一些模块任务需要的预配置工作，保证后面在test playbook上添加的任务能够正常推送到我们的目标主机上。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
ssh <a href="mailto:&#x72;&#111;&#x6f;&#116;&#64;&#116;&#101;&#115;&#116;&#x2e;&#101;&#120;&#97;&#x6d;&#x70;&#108;&#101;&#x2e;&#99;&#111;&#x6d;">&#x72;&#111;&#x6f;&#116;&#64;&#116;&#101;&#115;&#116;&#x2e;&#101;&#120;&#97;&#x6d;&#x70;&#108;&#101;&#x2e;&#99;&#111;&#x6d;</a>  # 此为待部署的目标主机</li>
</ul>
<p>[root@localhost ~]# useradd foo    #添加foo用户<br>[root@localhost ~]# useradd deploy     #添加deploy用户<br>[root@localhost ~]# mkdir /etc/nginx  # 创建nginx配置目录<br>[root@localhost ~]# rpm -Uvh <a target="_blank" rel="noopener" href="http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm">http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</a>    #安装nginx的yum源，保证后续可以使用ansible相应的模块在模板主机上安装nginx安装包<br>[root@localhost ~]# exit   #退出待部署的目标主机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">继续回到ansible所在的主机，依次执行下面的命令：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ pwd   #确保当前目录为/home/deploy/test_playbooks<br>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ vi roles/testbox/tasks/main.yml  #打开之前的main.yml主任务，我们在其后面新增一些模块任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后可以使用shift+G按键移动到文件的最后一行的最左边，接着使用shift+数字4按键移动到最后一行的最右边，然后在底下新起一行，新建对应的任务。</span><br><span class="line"></span><br><span class="line">****</span><br><span class="line"></span><br><span class="line">**一个创建文件的任务。**你需要往main.yml主任务中添加以下代码：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><p>name: create a file<br>file: ‘path=/root/foo.txt state=touch mode=0755 owner=foo group=foo’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后在`/home/deploy/test_playbooks`目录下，执行下面的命令，从而部署执行我们的create a file任务：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">当结果显示为下面的情况时，表示任务已经执行完成：</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-85dbbb9d2bd75f47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">其实你可以使用下面的命令进行验证（如出现下面的信息，则表示执行成功）：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ssh <a href="mailto:&#114;&#x6f;&#x6f;&#x74;&#64;&#116;&#x65;&#115;&#116;&#x2e;&#x65;&#120;&#97;&#x6d;&#112;&#108;&#x65;&#x2e;&#99;&#x6f;&#109;">&#114;&#x6f;&#x6f;&#x74;&#64;&#116;&#x65;&#115;&#116;&#x2e;&#x65;&#120;&#97;&#x6d;&#112;&#108;&#x65;&#x2e;&#99;&#x6f;&#109;</a> ls -al  /root/foo.txt   # 验证任务是否执行成功</p>
</li>
<li><p>rwxr-xr-x. 1 foo foo 0 4月  26 21:11 /root/foo.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">****</span><br><span class="line"></span><br><span class="line">**一个复制文件的任务。**接下来演示复制文件，但是前提是你ansible主机上有文件才行，因此需要新建`/home/deploy/test_playbooks/roles/testbox/files/foo.sh`文件和目录，然后`foo.sh`文件中的代码为：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>echo “this is a test script”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后保存退出即可。接着使用下面的命令来打开之前的main.yml主任务：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ vi roles/testbox/tasks/main.yml  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">我们在其后面新增copy模块任务：</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>name: copy a file<br>copy: ‘remote_src=no src=roles/testbox/files/foo.sh dest=/root/foo.sh mode=0644 force=yes’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">保存退出即可，接着在`/home/deploy/test_playbooks`目录下，执行下面的命令，从而部署执行我们的copya file任务：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">当结果显示为下面的情况时，表示任务已经执行完成：</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-47e961586baf41bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">****</span><br><span class="line"></span><br><span class="line">**stat和debug模块演示。**接下来演示stat和debug模块的使用，在`roles/testbox/tasks/main.yml`主任务文件中添加以下代码：</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>name: check if foo.sh exists<br>stat: ‘path=/root/foo.sh’<br>register: script_stat</p>
</li>
<li><p>debug: msg=”foo.sh exists”<br>when: script_stat.stat.exists</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">保存退出即可，接着在`/home/deploy/test_playbooks`目录下，执行下面的命令，从而部署执行我们的stat和debug模块任务：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">当结果显示为下面的情况时，表示任务已经执行完成：</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-2392ea8cee8596fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">****</span><br><span class="line"></span><br><span class="line">**command/shell模块演示。**接下来演示command/shell模块的使用，在`roles/testbox/tasks/main.yml`主任务文件中添加以下代码（二选一即可）：</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>name: run the script<br>command: “sh /root/foo.sh”</p>
</li>
<li><p>name: run the script<br>shell: “echo ‘test’ &gt;/root/test.txt”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">保存退出即可，接着在`/home/deploy/test_playbooks`目录下，执行下面的命令，从而部署执行我们的command/shell模块任务：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">当结果显示为下面的情况时，表示任务已经执行完成：</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-e5ca5ebe42ea095b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">****</span><br><span class="line"></span><br><span class="line">**template模块演示。**接下来演示template模块的使用。首先需要在`inventory/testenv`文件内添加一些参数，便于后续使用：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[testservers]<br>test.example.com</p>
</li>
</ul>
<p>[testservers:vars]<br>server_name=test.example.com<br>user=root<br>output=/root/test.txt<br>port=80  # 端口号<br>user=deploy  # 用户<br>worker_processes=4  # 进程数<br>max_open_file=65505  # 最大文件打开数量<br>root=/www  # 设置根目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">接着新建`/home/deploy/test_playbooks/roles/testbox/templates/nginx.conf.j2`文件和目录，然后`nginx.conf.j2`文件中的代码为：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>user              ;<br>worker_processes  ;  </p>
<p>error_log  /var/log/nginx/error.log;  </p>
<p>pid        /var/run/nginx.pid;  </p>
<p>events {<br>    worker_connections  ;<br>}  </p>
<p>http {<br>    include       /etc/nginx/mime.types;<br>    default_type  application/octet-stream;  </p>
<pre><code>log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;  
                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;  
                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;  

access_log  /var/log/nginx/access.log  main;  

sendfile        on;  
#tcp_nopush     on;  

#keepalive_timeout  0;  
keepalive_timeout  65;  

#gzip  on;  
  
# Load config files from the /etc/nginx/conf.d directory  
# The default server is in conf.d/default.conf  
#include /etc/nginx/conf.d/*.conf;  
server &#123;  
    listen       &#123;&#123; port &#125;&#125; default_server;  
    server_name  &#123;&#123; server_name &#125;&#125;;  

    #charset koi8-r;  

    #access_log  logs/host.access.log  main;  

    location / &#123;  
        root   &#123;&#123; root &#125;&#125;;  
        index  index.html index.htm;  
    &#125;  

    error_page  404              /404.html;  
    location = /404.html &#123;  
        root   /usr/share/nginx/html;  
    &#125;  

    # redirect server error pages to the static page /50x.html  
    #  
    error_page   500 502 503 504  /50x.html;  
    location = /50x.html &#123;  
        root   /usr/share/nginx/html;  
    &#125;  
&#125;  
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后在`roles/testbox/tasks/main.yml`主任务文件中添加以下代码（CentOS系统下使用yum安装软件）：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>name: write the nginx config file<br>template: src=roles/testbox/templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf</li>
<li>name: ensure nginx is at the latest version<br>yum: pkg=nginx state=latest</li>
<li>name: start nginx service<br>service: name=nginx state=started<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">保存退出即可，接着在`/home/deploy/test_playbooks`目录下，执行下面的命令，从而部署执行我们的command/shell模块任务：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">当结果显示为下面的情况时，表示任务已经执行完成：</span><br><span class="line"></span><br><span class="line">![](https://upload-images.jianshu.io/upload_images/8964398-1591b0b2fdbb072c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line"></span><br><span class="line">其实你可以使用下面的命令进行验证：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ssh <a href="mailto:&#114;&#111;&#x6f;&#x74;&#64;&#x74;&#x65;&#x73;&#x74;&#46;&#101;&#120;&#97;&#109;&#112;&#108;&#x65;&#x2e;&#x63;&#111;&#109;">&#114;&#111;&#x6f;&#x74;&#64;&#x74;&#x65;&#x73;&#x74;&#46;&#101;&#120;&#97;&#109;&#112;&#108;&#x65;&#x2e;&#x63;&#111;&#109;</a> cat /etc/nginx/nginx.conf # 验证任务是否执行成功<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">以及查看是否启动了nginx服务：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
(.py3-a2.5-env) [deploy@localhost test_playbooks]$ ssh <a href="mailto:&#x72;&#x6f;&#111;&#x74;&#64;&#116;&#x65;&#115;&#x74;&#46;&#x65;&#x78;&#97;&#109;&#x70;&#x6c;&#101;&#46;&#x63;&#x6f;&#x6d;">&#x72;&#x6f;&#111;&#x74;&#64;&#116;&#x65;&#115;&#x74;&#46;&#x65;&#x78;&#97;&#109;&#x70;&#x6c;&#101;&#46;&#x63;&#x6f;&#x6d;</a>  ps -ef|grep nginx  # 验证nginx是否启动成功<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 8个常用模块的任务模板</span><br><span class="line"></span><br><span class="line">为了更好的查阅代码，这里附上待测试的常用模块任务，即前面你往`roles/testbox/tasks/main.yml`文件中添加的代码：</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>name: create a file<br>file: ‘path=/root/foo.txt state=touch mode=0755 owner=foo group=foo’</li>
<li>name: copy a file<br>copy: ‘remote_src=no src=roles/testbox/files/foo.sh dest=/root/foo.sh mode=0644 force=yes’</li>
<li>name: check if foo.sh exists<br>stat: ‘path=/root/foo.sh’<br>register: script_stat</li>
<li>debug: msg=”foo.sh exists”<br>when: script_stat.stat.exists</li>
<li>name: run the script<br>command: “sh /root/foo.sh”</li>
<li>name: run the script<br>shell: “echo ‘test’ &gt;/root/test.txt”</li>
<li>name: write the nginx config file<br>template: src=roles/testbox/templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf</li>
<li>name: ensure nginx is at the latest version<br>yum: pkg=nginx state=latest</li>
<li>name: ensure nginx is at the latest version<br>apt: pkg=nginx state=latest</li>
<li>name: start nginx service<br>service: name=nginx state=started<br>```</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://envyzhan.asia">余思</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://envyzhan.asia/2020/01/11/devops-cicd-4-ansbile-playbook-introdution/">http://envyzhan.asia/2020/01/11/devops-cicd-4-ansbile-playbook-introdution/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://envyzhan.asia" target="_blank">余思博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cicd/">cicd</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/01/13/devops-cicd-5-jenkins-install/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CICD平台搭建：Jenkins安装</div></div></a></div><div class="next-post pull-right"><a href="/2020/01/09/devops-cicd-3-ansible-install/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CICD平台搭建：Ansible安装</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/01/07/devops-cicd-2-gitlab-used/" title="CICD平台搭建：Gitlab应用"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-07</div><div class="title">CICD平台搭建：Gitlab应用</div></div></a></div><div><a href="/2020/01/16/devops-cicd-7-jenkins-used/" title="CICD平台搭建：Jenkins应用"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-16</div><div class="title">CICD平台搭建：Jenkins应用</div></div></a></div><div><a href="/2020/01/05/devops-cicd-1-gitlab-install/" title="CICD平台搭建：Gitlab安装"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-05</div><div class="title">CICD平台搭建：Gitlab安装</div></div></a></div><div><a href="/2020/01/09/devops-cicd-3-ansible-install/" title="CICD平台搭建：Ansible安装"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-09</div><div class="title">CICD平台搭建：Ansible安装</div></div></a></div><div><a href="/2020/01/13/devops-cicd-5-jenkins-install/" title="CICD平台搭建：Jenkins安装"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-13</div><div class="title">CICD平台搭建：Jenkins安装</div></div></a></div><div><a href="/2020/01/15/devops-cicd-6-jenkins-job-install/" title="CICD平台搭建：Jenkins Job安装"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-15</div><div class="title">CICD平台搭建：Jenkins Job安装</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">余思</div><div class="author-info__description">记录成长路上的点滴</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">249</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:envyzhan@aliyun.com" target="_blank" title=""><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎访问余思博客，一个技术博主的成长试验田！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#playbook%E8%AF%AD%E8%A8%80%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">playbook语言介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#playbooks%E7%BC%96%E5%86%99%E8%A7%84%E8%8C%83"><span class="toc-number">2.</span> <span class="toc-text">playbooks编写规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E7%9B%AE%E5%BD%95testenv"><span class="toc-number">2.0.1.</span> <span class="toc-text">详细目录testenv</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#command%E6%A8%A1%E5%9D%97"><span class="toc-number">3.</span> <span class="toc-text">command模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#shell%E6%A8%A1%E5%9D%97"><span class="toc-number">4.</span> <span class="toc-text">shell模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CentOSs-RedHat%E7%B3%BB%E7%BB%9F"><span class="toc-number">5.</span> <span class="toc-text">CentOSs&#x2F;RedHat系统</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Debian-Ubuntu%E7%B3%BB%E7%BB%9F"><span class="toc-number">6.</span> <span class="toc-text">Debian&#x2F;Ubuntu系统</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/02/26/2023-12-use-jenkins-gitlab-to-package-and-deploy-the-springboot-application/" title="使用Jenkins+Gitlab一键打包部署SpringBoot应用"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用Jenkins+Gitlab一键打包部署SpringBoot应用"/></a><div class="content"><a class="title" href="/2023/02/26/2023-12-use-jenkins-gitlab-to-package-and-deploy-the-springboot-application/" title="使用Jenkins+Gitlab一键打包部署SpringBoot应用">使用Jenkins+Gitlab一键打包部署SpringBoot应用</a><time datetime="2023-02-26T14:55:30.000Z" title="发表于 2023-02-26 22:55:30">2023-02-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/24/2023-11-use-docker-compose-to-deploy-springboot-application/" title="使用Docker Compose部署SpringBoot应用"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用Docker Compose部署SpringBoot应用"/></a><div class="content"><a class="title" href="/2023/02/24/2023-11-use-docker-compose-to-deploy-springboot-application/" title="使用Docker Compose部署SpringBoot应用">使用Docker Compose部署SpringBoot应用</a><time datetime="2023-02-24T02:55:30.000Z" title="发表于 2023-02-24 10:55:30">2023-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/23/2023-10-use-dockerfil-to-build-docker-image-for-springboot-application/" title="使用Dockerfile为SpringBoot应用构建Docker镜像"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用Dockerfile为SpringBoot应用构建Docker镜像"/></a><div class="content"><a class="title" href="/2023/02/23/2023-10-use-dockerfil-to-build-docker-image-for-springboot-application/" title="使用Dockerfile为SpringBoot应用构建Docker镜像">使用Dockerfile为SpringBoot应用构建Docker镜像</a><time datetime="2023-02-23T10:15:33.000Z" title="发表于 2023-02-23 18:15:33">2023-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/20/2023-9-use-maven-plug-in-to-build-docker-image-for-springboot-application/" title="使用Maven插件为SpringBoot应用构建Docker镜像"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用Maven插件为SpringBoot应用构建Docker镜像"/></a><div class="content"><a class="title" href="/2023/02/20/2023-9-use-maven-plug-in-to-build-docker-image-for-springboot-application/" title="使用Maven插件为SpringBoot应用构建Docker镜像">使用Maven插件为SpringBoot应用构建Docker镜像</a><time datetime="2023-02-20T03:51:30.000Z" title="发表于 2023-02-20 11:51:30">2023-02-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/16/2023-8-integrate-rabbitmq-to-realize-delayed-messages/" title="整合RabbitMQ实现延迟消息"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="整合RabbitMQ实现延迟消息"/></a><div class="content"><a class="title" href="/2023/02/16/2023-8-integrate-rabbitmq-to-realize-delayed-messages/" title="整合RabbitMQ实现延迟消息">整合RabbitMQ实现延迟消息</a><time datetime="2023-02-16T02:51:12.000Z" title="发表于 2023-02-16 10:51:12">2023-02-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2023  余思博客,记录成长</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '9996b44b488f2fc52124',
      clientSecret: '6bec0f8e9c032eeae6211a5d4cffa3c97e2d4a64',
      repo: 'blogcomment',
      owner: 'Envythink',
      admin: ['Envythink'],
      id: 'f43b3ad39738e29f800b3e34925d4eda',
      updateCountCallback: commentCount
    },))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div></div></body></html>