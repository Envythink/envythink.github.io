<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>在完整Kubernetes集群上部署微服务 | 余思博客</title><meta name="keywords" content="Kubernetes"><meta name="author" content="余思"><meta name="copyright" content="余思"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="写在前面接下来我们尝试在完整集群上部署微服务，首先来复习之前的一些命令以及学习一个新的命令，了解这些对于学习和熟悉Kubernetes有非常大的帮助。 新的命令首先查看一下当前其他节点的运行状态信息，可以看到它们都是Ready状态： 1234[root@server02 ~]# kubectl get nodeNAME             STATUS    ROLES     AGE">
<meta property="og:type" content="article">
<meta property="og:title" content="在完整Kubernetes集群上部署微服务">
<meta property="og:url" content="http://envyzhan.asia/2022/07/08/2022-k8s-5-deploy-microservices-on-a-complete-cluster/index.html">
<meta property="og:site_name" content="余思博客">
<meta property="og:description" content="写在前面接下来我们尝试在完整集群上部署微服务，首先来复习之前的一些命令以及学习一个新的命令，了解这些对于学习和熟悉Kubernetes有非常大的帮助。 新的命令首先查看一下当前其他节点的运行状态信息，可以看到它们都是Ready状态： 1234[root@server02 ~]# kubectl get nodeNAME             STATUS    ROLES     AGE">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png">
<meta property="article:published_time" content="2022-07-08T09:55:30.000Z">
<meta property="article:modified_time" content="2022-09-12T08:47:31.154Z">
<meta property="article:author" content="余思">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://envyzhan.asia/2022/07/08/2022-k8s-5-deploy-microservices-on-a-complete-cluster/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '在完整Kubernetes集群上部署微服务',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-12 16:47:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="余思博客" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">253</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">19</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 前端</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page child" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page child" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li><li><a class="site-page child" href="/categories/flutter/"><i class="fa-fw fa fa-bullseye"></i><span> Flutter</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> Java</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page child" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page child" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page child" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page child" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 运维</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page child" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page child" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 中间件</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page child" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li><li><a class="site-page child" href="/categories/other/"><i class="fa-fw fa fa-location-arrow"></i><span> 其他</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bell"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 算法结构</span></a></li><li><a class="site-page child" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-address-book"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">余思博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 前端</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page child" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page child" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li><li><a class="site-page child" href="/categories/flutter/"><i class="fa-fw fa fa-bullseye"></i><span> Flutter</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> Java</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page child" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page child" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page child" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page child" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 运维</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page child" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page child" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 中间件</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page child" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li><li><a class="site-page child" href="/categories/other/"><i class="fa-fw fa fa-location-arrow"></i><span> 其他</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bell"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 算法结构</span></a></li><li><a class="site-page child" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-address-book"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">在完整Kubernetes集群上部署微服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-08T09:55:30.000Z" title="发表于 2022-07-08 17:55:30">2022-07-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-12T08:47:31.154Z" title="更新于 2022-09-12 16:47:31">2022-09-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>接下来我们尝试在完整集群上部署微服务，首先来复习之前的一些命令以及学习一个新的命令，了解这些对于学习和熟悉Kubernetes有非常大的帮助。</p>
<h1 id="新的命令"><a href="#新的命令" class="headerlink" title="新的命令"></a>新的命令</h1><p>首先查看一下当前其他节点的运行状态信息，可以看到它们都是Ready状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get node</span><br><span class="line">NAME             STATUS    ROLES     AGE       VERSION</span><br><span class="line">192.168.51.121   Ready     &lt;none&gt;    4h        v1.9.0</span><br><span class="line">192.168.51.123   Ready     &lt;none&gt;    4h        v1.9.0</span><br></pre></td></tr></table></figure>
<p>再来查看一下services，可以看到这里有一个Kubernetes默认的services：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.68.0.1    &lt;none&gt;        443/TCP   1d</span><br></pre></td></tr></table></figure>
<p>再来查看一下pods，正常应该就是没有的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get pods</span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure>
<p>接下来我们尝试通过<code>kubectl run</code>命令在k8s集群中部署一个命名为<code>kubernetes-bootcamp</code>的应用，Docker镜像通过<code>--image</code>指定，<code>--port</code>设置应用对外服务的端口，使用的命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl run kubernetes-bootcamp --image=jocatalin/kubernetes-bootcamp:v1 --port=8080</span><br><span class="line">deployment &quot;kubernetes-bootcamp&quot; created</span><br></pre></td></tr></table></figure>
<p>然后我们查看一下当前所有的deployments：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get deploy</span><br><span class="line">NAME                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kubernetes-bootcamp   1         1         1            1           41s</span><br></pre></td></tr></table></figure>
<p>才是再来查看一下pods，可以发现这里就创建了一个pods：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get pods</span><br><span class="line">NAME                                   READY     STATUS    RESTARTS   AGE</span><br><span class="line">kubernetes-bootcamp-6b7849c495-ssf78   1/1       Running   0          1m</span><br></pre></td></tr></table></figure>
<p>然后我们尝试查看一下某个pods中的运行日志信息，可使用<code>kubectl logs +pods名称</code>命令来进行查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl logs kubernetes-bootcamp-6b7849c495-ssf78</span><br><span class="line">Kubernetes Bootcamp App Started At: 2021-09-04T13:12:56.352Z | Running On:  kubernetes-bootcamp-6b7849c495-ssf78</span><br></pre></td></tr></table></figure>
<p>也可以借鉴docker logs命令，在上述kubectl logs命令后面添加<code>-f</code>参数来跟踪日志，这样一旦有刷新日志就会实时的刷新出来：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl logs kubernetes-bootcamp-6b7849c495-ssf78 -f</span><br></pre></td></tr></table></figure>
<p>我们再来查看一下这个pods的详细信息，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl describe pods kubernetes-bootcamp-6b7849c495-ssf78</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/8964398-4d4ad6b504184977.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>可以看到它多了一个Mounts的配置信息，值为<code>/var/run/secrets/kubernetes.io/serviceaccount</code>，然后我们可以使用类似于docker中的exec命令来以终端方式进入到该pods中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl exec -it kubernetes-bootcamp-6b7849c495-ssf78 bash</span><br><span class="line">root@kubernetes-bootcamp-6b7849c495-ssf78:/# ls -l /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 13 Sep  4 13:12 ca.crt -&gt; ..data/ca.crt</span><br><span class="line">lrwxrwxrwx 1 root root 16 Sep  4 13:12 namespace -&gt; ..data/namespace</span><br><span class="line">lrwxrwxrwx 1 root root 12 Sep  4 13:12 token -&gt; ..data/token</span><br><span class="line">root@kubernetes-bootcamp-6b7849c495-ssf78:/# cd /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">root@kubernetes-bootcamp-6b7849c495-ssf78:/var/run/secrets/kubernetes.io/serviceaccount# ls</span><br><span class="line">ca.crt	namespace  token</span><br><span class="line">root@kubernetes-bootcamp-6b7849c495-ssf78:/var/run/secrets/kubernetes.io/serviceaccount# </span><br></pre></td></tr></table></figure>
<p>可以看到这个<code>/var/run/secrets/kubernetes.io/serviceaccount</code>其实是一个目录，里面有三个文件，ca.crt是根证书文件，namespace的值为default，以及一个token文件。这些值是怎么来的呢？通过前面的学习可以知道它是与serviceaccount相关联的值。接下来我们看看当前是否存在serviceaccount，使用命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get serviceaccount</span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         1d</span><br></pre></td></tr></table></figure>
<p>也可以使用简写命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get sa</span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         1d</span><br></pre></td></tr></table></figure>
<p>可以看到这里有一个默认的名为default的namespace，可以使用如下命令来查看它的详细信息，其中<code>-o</code>指令用于指定输出的格式，这里我们让信息以yaml格式进行输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get sa -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">items:</span><br><span class="line">- apiVersion: v1</span><br><span class="line">  kind: ServiceAccount</span><br><span class="line">  metadata:</span><br><span class="line">    creationTimestamp: 2022-09-03T10:56:39Z</span><br><span class="line">    name: default</span><br><span class="line">    namespace: default</span><br><span class="line">    resourceVersion: &quot;142&quot;</span><br><span class="line">    selfLink: /api/v1/namespaces/default/serviceaccounts/default</span><br><span class="line">    uid: 16487d73-2b77-11ed-85ff-000c29e3dc2b</span><br><span class="line">  secrets:</span><br><span class="line">  - name: default-token-tq5m2</span><br><span class="line">kind: List</span><br><span class="line">metadata:</span><br><span class="line">  resourceVersion: &quot;&quot;</span><br><span class="line">  selfLink: &quot;&quot;</span><br></pre></td></tr></table></figure>
<p>你要是以json格式进行输出，这也是可以的。可以看到上面有一个名为<code>secrets.name</code>的配置项，它的值为default-token-tq5m2。开发者也可以使用如下命令查看一下当前所有的secrets：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get secrets</span><br><span class="line">NAME                  TYPE                                  DATA      AGE</span><br><span class="line">default-token-tq5m2   kubernetes.io/service-account-token   3         1d</span><br></pre></td></tr></table></figure>
<p>然后我们查看一下这个secrets的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get secrets -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">items:</span><br><span class="line">- apiVersion: v1</span><br><span class="line">  data:</span><br><span class="line">    ca.crt: ca.crt文件的内容</span><br><span class="line">    namespace: ZGVmYXVsdA==</span><br><span class="line">    token: token的值</span><br><span class="line">  kind: Secret</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      kubernetes.io/service-account.name: default</span><br><span class="line">      kubernetes.io/service-account.uid: 16487d73-2b77-11ed-85ff-000c29e3dc2b</span><br><span class="line">    creationTimestamp: 2021-09-03T10:56:39Z</span><br><span class="line">    name: default-token-tq5m2</span><br><span class="line">    namespace: default</span><br><span class="line">    resourceVersion: &quot;139&quot;</span><br><span class="line">    selfLink: /api/v1/namespaces/default/secrets/default-token-tq5m2</span><br><span class="line">    uid: 164a148f-2b77-11ed-85ff-000c29e3dc2b</span><br><span class="line">  type: kubernetes.io/service-account-token</span><br><span class="line">kind: List</span><br><span class="line">metadata:</span><br><span class="line">  resourceVersion: &quot;&quot;</span><br><span class="line">  selfLink: &quot;&quot;</span><br></pre></td></tr></table></figure>
<p>这其实就和我们之前在<code>/var/run/secrets/kubernetes.io/serviceaccount</code>目录中所看到的三个文件是一一对应的，相当于将这个secret赋给了每一个pod。这就说明如果APIServer的<code>kube-apiserver.service</code>文件中的<code>admission-control</code>配置项，如果配置了ServiceAccount，那么它就会在default这个namespace下创建一个默认的serviceaccount，然后每个pod在启动的时候会将这个service中的secret以文件的形式挂载到pod中。有了这些挂载的文件之后，我们的pod就可以通过https的方式去访问APIServer，也就是说让pod可以通过APIServer的认证。</p>
<p>接下来继续学习Kubernetes，回到<code>/home/envy/services</code>目录，可以看到里面有三个文件，这是之前我们创建的三个用于配置对应信息的文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# ls -l /home/envy/services/</span><br><span class="line">-rw-r--r-- 1 root root 274 8月  31 21:51 nginx-deployment.yaml</span><br><span class="line">-rw-r--r-- 1 root root 151 8月  31 21:24 nginx-pod.yaml</span><br><span class="line">-rw-r--r-- 1 root root 174 9月   2 21:47 nginx-service.yaml</span><br></pre></td></tr></table></figure>
<p>之前我们创建对应的deployment、pod和service时，使用了<code>kubectl create</code>命令，接下来我们尝试使用新的命令<code>kubectl apply</code>。我们利用<code>kubectl apply</code>来创建一个pod：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# kubectl apply -f nginx-pod.yaml </span><br><span class="line">pod &quot;nginx&quot; created</span><br></pre></td></tr></table></figure>
<p>再来看一下当前所有的pod：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# kubectl get pods</span><br><span class="line">NAME                                   READY     STATUS    RESTARTS   AGE</span><br><span class="line">kubernetes-bootcamp-6b7849c495-ssf78   1/1       Running   0          1h</span><br><span class="line">nginx                                  1/1       Running   0          4m</span><br></pre></td></tr></table></figure>
<p>然后查看一下名为nginx的pod的详细信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# kubectl describe pods nginx</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/8964398-2b90a2488a3badb4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>可以看到相比于kubectl create命令，它多了一个Annotations，里面记录的是最近一次的修改，会将修改的内容添加到里面，你会发现这个命令并没有将完整的修改内容都显示全，如果你想显示完全，可以使用如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 ~]# kubectl get pods nginx -o json</span><br><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">    &quot;kubectl.kubernetes.io/last-applied-configuration&quot;: &quot;&#123;\&quot;apiVersion\&quot;:\&quot;v1\&quot;,\&quot;kind\&quot;:\&quot;Pod\&quot;,\&quot;metadata\&quot;:&#123;\&quot;annotations\&quot;:&#123;&#125;,\&quot;name\&quot;:\&quot;nginx\&quot;,\&quot;namespace\&quot;:\&quot;default\&quot;&#125;,\&quot;spec\&quot;:&#123;\&quot;containers\&quot;:[&#123;\&quot;image\&quot;:\&quot;nginx:1.7.9\&quot;,\&quot;name\&quot;:\&quot;nginx\&quot;,\&quot;ports\&quot;:[&#123;\&quot;containerPort\&quot;:80&#125;]&#125;]&#125;&#125;\n&quot;</span><br><span class="line">&#125;,</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>可以看到这里面是我们上一次应用的完整配置，它起到了一个记录的功能，会将最近一次文件的配置内容放到annotations中进行存储，这样当应用出现问题的时候，它作为应用回滚的依据。还有一个区别，就是在使用<code>kubectl create</code>命令的时候，如果应用已经存在，那么必须将该应用删除，才能重新创建。而<code>kubectl apply</code>命令并不会重新去创建应用，而是会在之前应用的基础上进行修改。</p>
<p>举个例子，我们想创建一个基于nginx1.13版本的nginx-pod，此时该如何操作呢？可以使用<code>kubectl apply</code>命令，首先将<code>nginx-pod.yaml</code>文件中的nginx镜像版本由1.7.9修改为1.13：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: nginx:1.13</span><br><span class="line">      ports:</span><br><span class="line">      - containerPort: 80</span><br></pre></td></tr></table></figure>
<p>接着执行如下命令来创建nginx-pod：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# kubectl apply -f nginx-pod.yaml </span><br><span class="line">pod &quot;nginx&quot; configured</span><br></pre></td></tr></table></figure>
<p>然后使用如下命令来查看一下是否真的更新成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# kubectl get pods nginx -o json</span><br><span class="line">&quot;metadata&quot;: &#123;</span><br><span class="line">    &quot;annotations&quot;: &#123;</span><br><span class="line">        &quot;kubectl.kubernetes.io/last-applied-configuration&quot;: &quot;&#123;\&quot;apiVersion\&quot;:\&quot;v1\&quot;,\&quot;kind\&quot;:\&quot;Pod\&quot;,\&quot;metadata\&quot;:&#123;\&quot;annotations\&quot;:&#123;&#125;,\&quot;name\&quot;:\&quot;nginx\&quot;,\&quot;namespace\&quot;:\&quot;default\&quot;&#125;,\&quot;spec\&quot;:&#123;\&quot;containers\&quot;:[&#123;\&quot;image\&quot;:\&quot;nginx:1.13\&quot;,\&quot;name\&quot;:\&quot;nginx\&quot;,\&quot;ports\&quot;:[&#123;\&quot;containerPort\&quot;:80&#125;]&#125;]&#125;&#125;\n&quot;</span><br><span class="line">&#125;,</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>当然了，更新镜像还有之前使用的方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# kubectl set image pods nginx nginx=nginx:1.7.9</span><br><span class="line">pod &quot;nginx&quot; image updated</span><br></pre></td></tr></table></figure>
<p>再来看一下容器中的镜像，可以看到此时容器中的镜像已经变成1.7.9，但是Annotations中显示的镜像版本还是1.13，这是因为这个Annotations中始终保持的是配置文件中最新的配置，而无论开发者使用命令做任何修改，Annotations中始终都不会进行显示，这里只会显示配置文件中的修改。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/8964398-cc966d8f1931319b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>接下来我们使用<code>kubectl apply</code>来创建nginx-deployment和nginx-service这两个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# kubectl apply -f nginx-deployment.yaml </span><br><span class="line">deployment &quot;nginx-deployment&quot; created</span><br><span class="line">[root@server02 services]# kubectl apply -f nginx-service.yaml </span><br><span class="line">service &quot;nginx-service&quot; created</span><br></pre></td></tr></table></figure>
<p>接下来我们尝试使用NodeIP+NodePort方式来访问其他的Node节点，这是可以访问的:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# kubectl get svc</span><br><span class="line">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes      ClusterIP   10.68.0.1      &lt;none&gt;        443/TCP          2d</span><br><span class="line">nginx-service   NodePort    10.68.199.24   &lt;none&gt;        8080:20000/TCP   4m</span><br></pre></td></tr></table></figure>
<p>然后我们使用另一种方式，就是通过进入到容器中使用CLUSTER_IP+ServicePort这一方式来访问。由于这里需要进入到一个容器中，如果现在没有容器，可以使用<code>kubectl run busybox --rm=true --image=busybox --restart=Never --tty -i</code>来启动一个busybox镜像，这个镜像是专门用于测试，它启动完之后提供一些命令，就相当于运行在这个集群中的一个沙盒。<code> --rm=true</code>参数表示在结束的时候会自动删除，<code>--image=busybox</code>用于指定镜像为busybox，<code>--restart=Never</code>表示重启方案，此处设置从来不重启，即退出后就不重启。<code>--tty</code>表示开启一个伪终端，<code> -i</code>表示获取到标准输入。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 services]# kubectl run busybox --rm=true --image=busybox --restart=Never --tty -i</span><br><span class="line">If you don&#x27;t see a command prompt, try pressing enter.</span><br><span class="line">/ # </span><br><span class="line">/ # </span><br><span class="line">/ # ls</span><br><span class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br></pre></td></tr></table></figure>
<p>这样我们就进入了这个容器，我们可以使用wget命令，将wget输出定位到标准输出中，然后我们使用CLUSTER_IP+ServicePort这一方式来访问：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ # wget -qO - 10.68.199.24:8080</span><br></pre></td></tr></table></figure>
<p>如果出现nginx相关的页面信息，这就说明kube-proxy是正常的，然后我们将上面的IP修改为services的命令看看是否也能成功访问：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ # wget -qO - nginx-service:8080</span><br></pre></td></tr></table></figure>
<p>如果也出现nginx相关的页面信息，这就说明kube-dns也是正常的。</p>
<h1 id="微服务项目部署"><a href="#微服务项目部署" class="headerlink" title="微服务项目部署"></a>微服务项目部署</h1><h3 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h3><ul>
<li>消息服务：message-service</li>
<li>课程dubbo服务：course-dubbo-service</li>
<li>课程web服务：course-edge-service</li>
<li>用户thrift服务：user-thrift-service</li>
<li>用户web服务：user-edge-service</li>
<li>API网关：api-gateway</li>
</ul>
<p>如果将它们放到kunernetes集群中运行，我们需要考虑哪些问题呢？<br><strong>（1）哪些服务适合单独成一个pod？哪些服务适合在一个pod中？</strong><br>在Kubernetes中，最小的单元是pod，一个pod中可以包含一个或者多个容器，因此我们需要考虑我们有哪些服务是适合放在同一个pod中，还有哪些是适合单独成一个pod。如果将多个服务放在一个pod中，会有什么特征呢？毫无疑问两者之间的访问效率肯定是很高的，它们之间通过本机localhost就可以访问到处于同一个pod中的服务。</p>
<p>消息服务与其他的服务关联程度不大，而且所有的服务都可能去调用消息服务，因此它和谁放在一起都不太合适，可以将其单独做成一个pod。然后课程的dubbo服务和web服务这两个是紧密相关的，因为课程的dubbo服务大部分都是由web服务去调用的，两者的交换频率肯定会很高。因此课程的dubbo服务和web服务这两个可以放在同一个pod中。同理用户的thrift服务和web服务也应该放在同一个pod中。api网关可能会调用很多的服务，因此它并不适合和其他的服务放在一起，所以将其放在一个单独的pod中。</p>
<p><strong>（2）在一个pod里面的服务如何彼此访问？它们的服务如何对外提供服务？</strong><br>举个例子，如课程的dubbo服务和web服务，它们都在同一个pod中，两者是如何进行彼此通信的呢？可以通过本机的端口直接去访问，这是没问题的。在前面我们学习过service，知道我们的服务可以通过CLUSTER_IP或者通过kube-dns根据名字来进行解析，让我们的服务可以在集群内部进行访问，并且在一个service中可以同时定义多个端口，其实就是允许我们同时对外提供多个服务。这一点从技术上来说也是没有任何问题的。</p>
<p><strong>（3）单独的pod如何对外提供服务？</strong><br>单独的pod其实就更简单了，直接通过CLUSTER_IP或者通过kube-dns根据名字来进行解析，就可以直接提供集群内的服务了。</p>
<p><strong>（4）哪个服务作为整个服务的入口，入口服务如何对外提供服务？</strong><br>最后比较特殊的就是API网关，它作为整个服务的入口，为了对外提供服务，它需要提供一个NodePort，这样就让我们在集群外，也可以访问到这个服务，这就是api-gateway需要对外提供服务的方式，即它需要使用到NodePort。</p>
<h3 id="搞定配置"><a href="#搞定配置" class="headerlink" title="搞定配置"></a>搞定配置</h3><p>配置的模板已经设置好了，就是按照前面所说的服务划分，但是开发者还需要做一些配置，将这些配置文件中的变量进行配置。进入到主节点中，我们先进入到如下目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cd /home/envy/kubernetes-starter/service-config/</span><br></pre></td></tr></table></figure>
<p>然后查看一下当前的目录文件信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line">api-gateway.yaml     message-service.yaml</span><br><span class="line">course-service.yaml  user-service.yaml</span><br><span class="line">#替换变量 - (hub.envyzhan.com:9080是我的环境的镜像仓库地址，大家修改为各自的仓库)</span><br><span class="line">$ sed -i &#x27;s/&#123;&#123;HUB&#125;&#125;/hub.envyzhan.com:9080/g&#x27; *</span><br></pre></td></tr></table></figure>
<p>接下来查看各个文件的信息，<code>api-gateway.yaml</code>配置文件内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: api-gateway</span><br><span class="line">  name: api-gateway</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    nodePort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: api-gateway</span><br><span class="line">  type: NodePort</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: api-gateway-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: api-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: api-gateway</span><br><span class="line">        image: hub.envyzhan.com:9080/micro-service/api-gateway-zuul:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br></pre></td></tr></table></figure>
<p>接着我们再来看一下<code>message-service.yaml</code>配置文件的内容，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: message-service</span><br><span class="line">  name: message-service</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9090</span><br><span class="line">  selector:</span><br><span class="line">    app: message-service</span><br><span class="line">  type: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: message-service-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: message-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: message-service</span><br><span class="line">        image: hub.envyzhan.com:9080/micro-service/message-service:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br></pre></td></tr></table></figure>
<p>可以看到这个Service的类型是ClusterIP，因为它不需要对外提供服务，只需在集群内提供服务。</p>
<p>再来看一下<code>course-service.yaml</code>配置文件的内容，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: course-service</span><br><span class="line">  name: course-service</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8081</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8081</span><br><span class="line">  selector:</span><br><span class="line">    app: course-service</span><br><span class="line">  type: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: course-service-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: course-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: course-service</span><br><span class="line">        image: hub.envyzhan.com:9080/micro-service/course-service:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">      - name: course-edge-service</span><br><span class="line">        image: hub.envyzhan.com:9080/micro-service/course-edge-service:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8081</span><br></pre></td></tr></table></figure>
<p>可以看到里面有两个容器，一个是course-service，容器端口为20880，另一个则是course-edge-service，容器端口为8081，这个与名为course-service的service所指定的service端口是一致的。这是因为这个8081是在集群内提供给其他服务所使用的，而这个20880它只需要给这个course-edge-service使用就可以，因为别的服务并没有使用到它，也没有依赖它，因此上面我们只需指定一个端口。</p>
<p>最后再来看一下这个<code>user-service.yaml</code>配置文件的内容，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: user-service</span><br><span class="line">  name: user-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: user-edge-service-port</span><br><span class="line">    port: 8082</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  - name: user-service-port</span><br><span class="line">    port: 7911</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 7911</span><br><span class="line">  selector:</span><br><span class="line">    app: user-service</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: user-service-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: user-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: user-service</span><br><span class="line">        image: hub.envyzhan.com:9080/micro-service/user-service:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 7911</span><br><span class="line">      - name: user-edge-service</span><br><span class="line">        image: hub.envyzhan.com:9080/micro-service/user-edge-service:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8082</span><br></pre></td></tr></table></figure>
<p>可以看到这个名为user-service的service里面提供了两个port，一个是user-edge-service-port，端口号为8082；另一个则是user-service-port，端口号为7911，注意定义多个port时就需要开发者指定名称。一个是方便我们记忆，另一个则是方便后来维护的人，这些port分别用于做什么事情。这就表明这两个port在集群中，都是提供给集群内其他port来使用的。后面的user-service-deployment中也是有两个容器，一个是user-service，另一个则是user-edge-service。</p>
<p>可以看到user-service和course-service这两个service的唯一区别在于，course-service只定义了一个端口用于对外提供服务，而user-service却需要提供两个端口，且这两个端口都需要对外提供服务。</p>
<h1 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h1><p>（1）启动Harbor。由于在前面我们已经将harbor设置为开机自启动，因此这里会自己启动。<br>（2）启动MySQL。进入到<code>/opt/mysql</code>目录，在里面执行其中的<code>start.sh</code>脚本文件即可启动MySQL。<br>（3）启动Redis。进入到<code>/opt/redis</code>目录，在里面执行其中的<code>start.sh</code>脚本文件即可启动Redis。<br>（4）启动Zookeeper。由于在前面我们已经将Zookeeper设置为开机自启动，因此这里会自己启动。</p>
<h1 id="梳理代码"><a href="#梳理代码" class="headerlink" title="梳理代码"></a>梳理代码</h1><p><strong>（1）api-gateway-zuul微服务配置信息改造。</strong>api-gateway-zuul微服务原有的配置信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 服务名称和端口号</span><br><span class="line">server:</span><br><span class="line">  name: gateway-zuul-service</span><br><span class="line">  port: 8080</span><br><span class="line"># zuul相关配置信息</span><br><span class="line">zuul:</span><br><span class="line">  routes:</span><br><span class="line">    course:</span><br><span class="line">      path: /course/**</span><br><span class="line">      url: http://course-edge-service:8023/course/</span><br><span class="line">    user:</span><br><span class="line">      path: /user/**</span><br><span class="line">      url: http://user-edge-service:8022/user/</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/8964398-64bbb1922dbb23e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/8964398-b8aba803fb800f22.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>修改之后的<code>application.yml</code>配置文件的信息为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 服务名称和端口号</span><br><span class="line">server:</span><br><span class="line">  name: gateway-zuul-service</span><br><span class="line">  port: 8080</span><br><span class="line"># zuul相关配置信息</span><br><span class="line">zuul:</span><br><span class="line">  routes:</span><br><span class="line">    course:</span><br><span class="line">      path: /course/**</span><br><span class="line">      url: http://course-service:8081/course/</span><br><span class="line">    user:</span><br><span class="line">      path: /user/**</span><br><span class="line">      url: http://user-service:8082/user/</span><br></pre></td></tr></table></figure>
<p><strong>（2）course-dubbo-service微服务配置信息改造。</strong>course-dubbo-service微服务原有的配置信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 用户服务的IP和端口号</span><br><span class="line">thrift:</span><br><span class="line">  user:</span><br><span class="line">    ip: user-service</span><br><span class="line">    port: 7911</span><br><span class="line"># 数据源的配置信息</span><br><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://192.168.51.100:3306/db_course</span><br><span class="line">    username: root</span><br><span class="line">    password: envy123</span><br><span class="line"># dubbo相关配置</span><br><span class="line">dubbo:</span><br><span class="line">  application:</span><br><span class="line">    name: course-service</span><br><span class="line">  registry:</span><br><span class="line">    address: zookeeper://192.168.51.100:2181</span><br><span class="line">  protocol:</span><br><span class="line">    name: dubbo</span><br><span class="line">    port: 20880</span><br><span class="line">#    host: 192.168.51.6</span><br><span class="line">  scan:</span><br><span class="line">    base-packages: com.envy.course</span><br></pre></td></tr></table></figure>
<p>通过对比发现这个服务的配置信息无需进行修改。<br><strong>（3）course-edge-service微服务配置信息改造。</strong>course-edge-service微服务原有的配置信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 服务名称和端口号</span><br><span class="line">server:</span><br><span class="line">  name: course-edge-service</span><br><span class="line">  port: 8023</span><br><span class="line"># dubbo相关配置</span><br><span class="line">dubbo:</span><br><span class="line">  application:</span><br><span class="line">    name: course-service</span><br><span class="line">  registry:</span><br><span class="line">    address: zookeeper://$&#123;zookeeper.url&#125;:2181</span><br><span class="line">  protocol:</span><br><span class="line">    name: dubbo</span><br><span class="line">    port: 20880</span><br><span class="line">#    host: 192.168.51.6</span><br><span class="line">  scan:</span><br><span class="line">    base-packages: com.envy.course</span><br></pre></td></tr></table></figure>
<p>修改之后的<code>application.yml</code>配置文件的信息为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 服务名称和端口号</span><br><span class="line">server:</span><br><span class="line">  name: course-edge-service</span><br><span class="line">  port: 8023</span><br><span class="line"># dubbo相关配置</span><br><span class="line">dubbo:</span><br><span class="line">  application:</span><br><span class="line">    name: course-service</span><br><span class="line">  registry:</span><br><span class="line">    address: zookeeper://192.168.51.100:2181</span><br><span class="line">  protocol:</span><br><span class="line">    name: dubbo</span><br><span class="line">    port: 20880</span><br><span class="line">  scan:</span><br><span class="line">    base-packages: com.envy.course</span><br><span class="line">user:</span><br><span class="line">  edge:</span><br><span class="line">    service:</span><br><span class="line">      addr: user-service:8082</span><br></pre></td></tr></table></figure>
<p><strong>（4）user-edge-service微服务配置信息改造。</strong>user-edge-service微服务原有的配置信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 服务名称和端口号</span><br><span class="line">server:</span><br><span class="line">  name: user-edge-service</span><br><span class="line">  port: 8022</span><br><span class="line"></span><br><span class="line"># 用户服务的IP和端口号</span><br><span class="line">thrift:</span><br><span class="line">  user:</span><br><span class="line">    ip: user-service</span><br><span class="line">    port: 7911</span><br><span class="line"># 短信服务的IP和端口号</span><br><span class="line">  message:</span><br><span class="line">    ip: message-service</span><br><span class="line">    port: 9090</span><br><span class="line"></span><br><span class="line"># Redis配置信息</span><br><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    host: $&#123;redis.url&#125;</span><br><span class="line">    port: 6379</span><br><span class="line">    timeout: 30000</span><br></pre></td></tr></table></figure>
<p>修改之后的<code>application.yml</code>配置文件的信息为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 服务名称和端口号</span><br><span class="line">server:</span><br><span class="line">  name: user-edge-service</span><br><span class="line">  port: 8022</span><br><span class="line"></span><br><span class="line"># 用户服务的IP和端口号</span><br><span class="line">thrift:</span><br><span class="line">  user:</span><br><span class="line">    ip: user-service</span><br><span class="line">    port: 7911</span><br><span class="line"># 短信服务的IP和端口号</span><br><span class="line">  message:</span><br><span class="line">    ip: message-service</span><br><span class="line">    port: 9090</span><br><span class="line"></span><br><span class="line"># Redis配置信息</span><br><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    host: 192.168.51.100</span><br><span class="line">    port: 6379</span><br><span class="line">    timeout: 30000</span><br></pre></td></tr></table></figure>
<p><strong>（5）user-thrift-service微服务配置信息改造。</strong>user-thrift-service微服务原有的配置信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 服务名称和端口号</span><br><span class="line">server:</span><br><span class="line">  name: user-thrift-service</span><br><span class="line">  port: 7911</span><br><span class="line"># 数据源的配置信息</span><br><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://$&#123;mysql.url&#125;:3306/db_user</span><br><span class="line">    username: root</span><br><span class="line">    password: envy123</span><br></pre></td></tr></table></figure>
<p>修改之后的<code>application.yml</code>配置文件的信息为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 服务名称和端口号</span><br><span class="line">server:</span><br><span class="line">  name: user-thrift-service</span><br><span class="line">  port: 7911</span><br><span class="line"># 数据源的配置信息</span><br><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://192.168.51.100:3306/db_user</span><br><span class="line">    username: root</span><br><span class="line">    password: envy123</span><br></pre></td></tr></table></figure>
<h3 id="重新打包镜像"><a href="#重新打包镜像" class="headerlink" title="重新打包镜像"></a>重新打包镜像</h3><p>将下来我们需要将之前我们修改过配置文件的服务，都重新打包成镜像，这个过程在前面都已经进行了介绍，这里就不过多介绍了。</p>
<h3 id="删除现有的服务"><a href="#删除现有的服务" class="headerlink" title="删除现有的服务"></a>删除现有的服务</h3><p>首先进入到主节点，查看一下当前所有的服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl get svc</span><br><span class="line">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes      ClusterIP   10.68.0.1      &lt;none&gt;        443/TCP          3d</span><br><span class="line">nginx-service   NodePort    10.68.199.24   &lt;none&gt;        8080:20000/TCP   1d</span><br></pre></td></tr></table></figure>
<p>考虑到后面这个nginx-service可能会影响到现有的服务，这里我们将这个服务给删除掉：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl delete svc nginx-service</span><br><span class="line">service &quot;nginx-service&quot; deleted</span><br></pre></td></tr></table></figure>
<p>同理查看一下当前所有的deployments：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl get deploy</span><br><span class="line">NAME                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kubernetes-bootcamp   1         1         1            1           2d</span><br><span class="line">nginx-deployment      2         2         2            2           1d</span><br></pre></td></tr></table></figure>
<p>删除上述两个deployment：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl delete deploy nginx-deployment</span><br><span class="line">deployment &quot;nginx-deployment&quot; deleted</span><br><span class="line">[root@server02 service-config]# kubectl delete deploy kubernetes-bootcamp</span><br><span class="line">deployment &quot;kubernetes-bootcamp&quot; deleted</span><br></pre></td></tr></table></figure>
<p>再来查看一下当前所有的pods：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl get pods</span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE</span><br><span class="line">nginx     1/1       Running   0          1d</span><br></pre></td></tr></table></figure>
<p>删除这个名为nginx的pod：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl delete pod nginx</span><br><span class="line">pod &quot;nginx&quot; deleted</span><br></pre></td></tr></table></figure>
<p>接着进入到主节点所在机器，我们需要在它的<code>/etc/hosts</code>文件中新增一条映射信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.51.100 hub.envyzhan.com</span><br></pre></td></tr></table></figure>
<p>然后我们进入到<code>/home/envy/kubernetes-starter/service-config</code>目录，开始根据对应的配置文件创建对应的Service、Deployment。注意它们是有依赖关系的，因此创建顺序不能搞错，必须是【message-service.yaml】–&gt;【user-service.yaml】–&gt;【course-service.yaml】–&gt;【api-gateway.yaml】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl apply -f message-service.yaml </span><br><span class="line">service &quot;message-service&quot; created</span><br><span class="line">deployment &quot;message-service-deployment&quot; created</span><br><span class="line"></span><br><span class="line">[root@server02 service-config]# kubectl apply -f user-service.yaml </span><br><span class="line">service &quot;user-service&quot; created</span><br><span class="line">deployment &quot;user-service-deployment&quot; created</span><br><span class="line"></span><br><span class="line">[root@server02 service-config]# kubectl apply -f course-service.yaml </span><br><span class="line">service &quot;course-service&quot; created</span><br><span class="line">deployment &quot;course-service-deployment&quot; created</span><br><span class="line"></span><br><span class="line">[root@server02 service-config]# kubectl apply -f api-gateway.yaml </span><br><span class="line">deployment &quot;api-gateway-deployment&quot; created</span><br><span class="line">The Service &quot;api-gateway&quot; is invalid: spec.ports[0].nodePort: Invalid value: 80: provided port is not in the valid range. The range of valid ports is 20000-40000</span><br></pre></td></tr></table></figure>
<p>可以看到我们在创建api-gateway这一NodePort时出现问题，原因是我们在APIServer中规定了节点端口必须在2万-4万之间，而此处的80端口是不在里面，所以就抛出异常。此时我们可以修改APIServer的配置信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# vi /lib/systemd/system/kube-apiserver.service</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/8964398-51e96c44aa35c6cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>我们可以将其中的2万-4万修改为80-4万，这样就好了，当然你可以让api-gateway它的NodePort修改为2万-4万之间的值，只是此时用起来就不太方便了。之后依次执行如下命令来重启APIServer：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# systemctl daemon-reload</span><br><span class="line">[root@server02 service-config]# systemctl restart kube-apiserver</span><br></pre></td></tr></table></figure>
<p>之后我们再次重新执行上述<code>kubectl apply -f api-gateway.yaml</code>命令，可以看到此时就不抛出异常了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl apply -f api-gateway.yaml </span><br><span class="line">service &quot;api-gateway&quot; created</span><br><span class="line">deployment &quot;api-gateway-deployment&quot; unchanged</span><br></pre></td></tr></table></figure>
<p>接着我们查看一下当前所有的service信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl get svc</span><br><span class="line">NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">api-gateway       NodePort    10.68.180.221   &lt;none&gt;        80:80/TCP           22s</span><br><span class="line">course-service    ClusterIP   10.68.54.94     &lt;none&gt;        8081/TCP            7m</span><br><span class="line">kubernetes        ClusterIP   10.68.0.1       &lt;none&gt;        443/TCP             3d</span><br><span class="line">message-service   ClusterIP   10.68.24.72     &lt;none&gt;        9090/TCP            7m</span><br><span class="line">user-service      ClusterIP   10.68.77.158    &lt;none&gt;        8082/TCP,7911/TCP   7m</span><br></pre></td></tr></table></figure>
<p>再来查看一下当前所有的deployments：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl get deploy</span><br><span class="line">NAME                         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">api-gateway-deployment       1         1         1            0           8m</span><br><span class="line">course-service-deployment    1         1         1            0           9m</span><br><span class="line">message-service-deployment   1         1         1            0           9m</span><br><span class="line">user-service-deployment      1         1         1            0           9m</span><br></pre></td></tr></table></figure>
<p>可以看到现在AVAILABLE的个数为0，表示一个都无法使用。那我们查看当前所有的pod信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl get pods -o wide</span><br><span class="line">NAME                                          READY     STATUS             RESTARTS   AGE       IP              NODE</span><br><span class="line">api-gateway-deployment-68f4694877-2s8nv       0/1       ImagePullBackOff   0          14m       172.20.188.9    192.168.51.121</span><br><span class="line">course-service-deployment-ff6f7d4b8-snm7l     0/2       ImagePullBackOff   0          14m       172.20.40.198   192.168.51.123</span><br><span class="line">message-service-deployment-64c49f8ff8-48r8g   0/1       ImagePullBackOff   0          14m       172.20.188.7    192.168.51.121</span><br><span class="line">user-service-deployment-8674c798b7-8bbck      0/2       ImagePullBackOff   0          14m       172.20.188.8    192.168.51.12</span><br></pre></td></tr></table></figure>
<p>可以看到原来它们都在拉取镜像，这个速度有点慢。为了保险起见，接下来我们查看一下日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 service-config]# kubectl logs -f api-gateway-deployment-68f4694877-2s8nv</span><br><span class="line">Error from server (BadRequest): container &quot;api-gateway&quot; in pod &quot;api-gateway-deployment-68f4694877-2s8nv&quot; is waiting to start: trying and failing to pull image</span><br></pre></td></tr></table></figure>
<p>可以看到镜像拉取失败，我们尝试登陆到harbor镜像仓库上<code>docker login http://hub.envyzhan.com:9080</code>，可以看到错误信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error response from daemon: Get &quot;https://hub.envyzhan.com:9080/v2/&quot;: http: server gave HTTP response to HTTPS client</span><br></pre></td></tr></table></figure>
<p>在主节点上的<code>/etc/docker/daemon.json</code>文件中新增一个不安全镜像仓库的配置信息，注意值必须是数组形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;registry-mirrors&quot;: [&quot;http://f1361db2.m.daocloud.io&quot;],</span><br><span class="line"> &quot;insecure-registries&quot;: [&quot;hub.envyzhan.com:9080&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们依次执行如下命令来重新启动docker：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server02 docker]# systemctl daemon-reload</span><br><span class="line">[root@server02 docker]# systemctl restart docker</span><br></pre></td></tr></table></figure>
<p>之后我们再重新执行上述<code>kubectl apply -f</code>命令。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://envyzhan.asia">余思</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://envyzhan.asia/2022/07/08/2022-k8s-5-deploy-microservices-on-a-complete-cluster/">http://envyzhan.asia/2022/07/08/2022-k8s-5-deploy-microservices-on-a-complete-cluster/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://envyzhan.asia" target="_blank">余思博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/02/15-springboot-integrates-canal-to-realize-data-incremental-synchronization/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringBoot整合Canal实现数据增量同步</div></div></a></div><div class="next-post pull-right"><a href="/2022/07/06/2022-k8s-4-complete-cluster-construction/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kubernetes完整集群搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/06/28/2022-k8s-1-basic-knowledge/" title="Kubernetes基础知识"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-28</div><div class="title">Kubernetes基础知识</div></div></a></div><div><a href="/2022/06/28/2022-k8s-2-simple-environment-construction/" title="Kubernetes基础知识"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-28</div><div class="title">Kubernetes基础知识</div></div></a></div><div><a href="/2022/07/04/2022-k8s-3-simple-environemnt-use/" title="Kubernetes简易环境使用"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-04</div><div class="title">Kubernetes简易环境使用</div></div></a></div><div><a href="/2022/07/06/2022-k8s-4-complete-cluster-construction/" title="Kubernetes完整集群搭建"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-06</div><div class="title">Kubernetes完整集群搭建</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">余思</div><div class="author-info__description">记录成长路上的点滴</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">253</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">19</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:envyzhan@aliyun.com" target="_blank" title=""><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎访问余思博客，一个技术博主的成长试验田！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%B0%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">2.</span> <span class="toc-text">新的命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-number">3.</span> <span class="toc-text">微服务项目部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">3.0.1.</span> <span class="toc-text">思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9E%E5%AE%9A%E9%85%8D%E7%BD%AE"><span class="toc-number">3.0.2.</span> <span class="toc-text">搞定配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.</span> <span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A2%B3%E7%90%86%E4%BB%A3%E7%A0%81"><span class="toc-number">5.</span> <span class="toc-text">梳理代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E6%89%93%E5%8C%85%E9%95%9C%E5%83%8F"><span class="toc-number">5.0.1.</span> <span class="toc-text">重新打包镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%8E%B0%E6%9C%89%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.0.2.</span> <span class="toc-text">删除现有的服务</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/05/28/2023-104-cleverly-using-paginated-list-caching-to-quickly-respond-to-user-requests/" title="巧用分页列表缓存，快速响应用户请求"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="巧用分页列表缓存，快速响应用户请求"/></a><div class="content"><a class="title" href="/2023/05/28/2023-104-cleverly-using-paginated-list-caching-to-quickly-respond-to-user-requests/" title="巧用分页列表缓存，快速响应用户请求">巧用分页列表缓存，快速响应用户请求</a><time datetime="2023-05-28T08:55:30.000Z" title="发表于 2023-05-28 16:55:30">2023-05-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/10/2023-103-implementation-of-interface-idempotency-verification-based-on-reqParam/" title="基于请求参数校验的接口幂等性实现方案"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基于请求参数校验的接口幂等性实现方案"/></a><div class="content"><a class="title" href="/2023/05/10/2023-103-implementation-of-interface-idempotency-verification-based-on-reqParam/" title="基于请求参数校验的接口幂等性实现方案">基于请求参数校验的接口幂等性实现方案</a><time datetime="2023-05-10T02:55:30.000Z" title="发表于 2023-05-10 10:55:30">2023-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/20/2023-102-redis-skillfully-uses-various-data-types/" title="Redis各种数据类型巧用"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis各种数据类型巧用"/></a><div class="content"><a class="title" href="/2023/04/20/2023-102-redis-skillfully-uses-various-data-types/" title="Redis各种数据类型巧用">Redis各种数据类型巧用</a><time datetime="2023-04-20T02:55:30.000Z" title="发表于 2023-04-20 10:55:30">2023-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/06/2023-101-talk-about-the-bloom-filter-in-redis/" title="聊一聊Redis中的布隆过滤器"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="聊一聊Redis中的布隆过滤器"/></a><div class="content"><a class="title" href="/2023/04/06/2023-101-talk-about-the-bloom-filter-in-redis/" title="聊一聊Redis中的布隆过滤器">聊一聊Redis中的布隆过滤器</a><time datetime="2023-04-06T11:55:30.000Z" title="发表于 2023-04-06 19:55:30">2023-04-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/01/2023-100-practice-of-function-switch-in-business/" title="功能开关在业务中的实践"><img src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="功能开关在业务中的实践"/></a><div class="content"><a class="title" href="/2023/03/01/2023-100-practice-of-function-switch-in-business/" title="功能开关在业务中的实践">功能开关在业务中的实践</a><time datetime="2023-03-01T09:55:30.000Z" title="发表于 2023-03-01 17:55:30">2023-03-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2023  余思博客,记录成长</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '9996b44b488f2fc52124',
      clientSecret: '6bec0f8e9c032eeae6211a5d4cffa3c97e2d4a64',
      repo: 'blogcomment',
      owner: 'Envythink',
      admin: ['Envythink'],
      id: '81b11204abb158e8e16f22e9caa789b3',
      updateCountCallback: commentCount
    },))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div></div></body></html>