<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>整合单机版FastDFS | 余思博客</title><meta name="description" content="整合单机版FastDFS"><meta name="keywords" content="springboot"><meta name="author" content="余思"><meta name="copyright" content="余思"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="整合单机版FastDFS"><meta name="twitter:description" content="整合单机版FastDFS"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="整合单机版FastDFS"><meta property="og:url" content="http://envyzhan.top/2019/09/28/springboot-22-union-one-fastDFS/"><meta property="og:site_name" content="余思博客"><meta property="og:description" content="整合单机版FastDFS"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://envyzhan.top/2019/09/28/springboot-22-union-one-fastDFS/"><link rel="prev" title="Spring Cloud Eureka介绍" href="http://envyzhan.top/2019/11/01/spring-cloud-eureka-1-introdution/"><link rel="next" title="项目构建与部署" href="http://envyzhan.top/2019/09/25/springboot-21-project-build-and-development/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://envythink.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: 余思","link":"链接: http://envyzhan.top/2019/09/28/springboot-22-union-one-fastDFS/","source":"来源: 余思博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">余思博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-html5" aria-hidden="true"></i><span> 前端</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> Java</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 运维</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 中间件</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page" href="/categories/nginx/"><i class="fa-fw fa fa-location-arrow"></i><span> Nginx</span></a></li><li><a class="site-page" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bell" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 数据结构</span></a></li><li><a class="site-page" href="/categories/algorithm/"><i class="fa-fw fa fa-plane"></i><span> 算法建模</span></a></li><li><a class="site-page" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-address-book" aria-hidden="true"></i><span> 生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">213</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">15</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-html5" aria-hidden="true"></i><span> 前端</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> Java</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 运维</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 中间件</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page" href="/categories/nginx/"><i class="fa-fw fa fa-location-arrow"></i><span> Nginx</span></a></li><li><a class="site-page" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bell" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 数据结构</span></a></li><li><a class="site-page" href="/categories/algorithm/"><i class="fa-fw fa fa-plane"></i><span> 算法建模</span></a></li><li><a class="site-page" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-address-book" aria-hidden="true"></i><span> 生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#FastDFS"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">FastDFS</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#FastDFS简介"><span class="toc_mobile_items-number">1.0.1.</span> <span class="toc_mobile_items-text">FastDFS简介</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#FastDFS架构"><span class="toc_mobile_items-number">1.0.2.</span> <span class="toc_mobile_items-text">FastDFS架构</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#FastDFS的三种角色"><span class="toc_mobile_items-number">1.0.3.</span> <span class="toc_mobile_items-text">FastDFS的三种角色</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#FastDFS的存储策略"><span class="toc_mobile_items-number">1.0.4.</span> <span class="toc_mobile_items-text">FastDFS的存储策略</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#文件上传的内部机制"><span class="toc_mobile_items-number">1.0.5.</span> <span class="toc_mobile_items-text">文件上传的内部机制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#文件下载的内部机制"><span class="toc_mobile_items-number">1.0.6.</span> <span class="toc_mobile_items-text">文件下载的内部机制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#文件同步的内部机制"><span class="toc_mobile_items-number">1.0.7.</span> <span class="toc_mobile_items-text">文件同步的内部机制</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#单机版FastDFS"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">单机版FastDFS</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#单机版FastDFS的安装"><span class="toc_mobile_items-number">2.0.1.</span> <span class="toc_mobile_items-text">单机版FastDFS的安装</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装Nginx"><span class="toc_mobile_items-number">2.0.2.</span> <span class="toc_mobile_items-text">安装Nginx</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#FastDFS配置Nginx模块"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">FastDFS配置Nginx模块</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装配置Nginx模块"><span class="toc_mobile_items-number">3.0.1.</span> <span class="toc_mobile_items-text">安装配置Nginx模块</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#SpringBoot整合单机版FastDFS"><span class="toc_mobile_items-number">3.0.2.</span> <span class="toc_mobile_items-text">SpringBoot整合单机版FastDFS</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#访问权限控制"><span class="toc_mobile_items-number">3.0.3.</span> <span class="toc_mobile_items-text">访问权限控制</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FastDFS"><span class="toc-number">1.</span> <span class="toc-text">FastDFS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FastDFS简介"><span class="toc-number">1.0.1.</span> <span class="toc-text">FastDFS简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastDFS架构"><span class="toc-number">1.0.2.</span> <span class="toc-text">FastDFS架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastDFS的三种角色"><span class="toc-number">1.0.3.</span> <span class="toc-text">FastDFS的三种角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastDFS的存储策略"><span class="toc-number">1.0.4.</span> <span class="toc-text">FastDFS的存储策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件上传的内部机制"><span class="toc-number">1.0.5.</span> <span class="toc-text">文件上传的内部机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件下载的内部机制"><span class="toc-number">1.0.6.</span> <span class="toc-text">文件下载的内部机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件同步的内部机制"><span class="toc-number">1.0.7.</span> <span class="toc-text">文件同步的内部机制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#单机版FastDFS"><span class="toc-number">2.</span> <span class="toc-text">单机版FastDFS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#单机版FastDFS的安装"><span class="toc-number">2.0.1.</span> <span class="toc-text">单机版FastDFS的安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Nginx"><span class="toc-number">2.0.2.</span> <span class="toc-text">安装Nginx</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FastDFS配置Nginx模块"><span class="toc-number">3.</span> <span class="toc-text">FastDFS配置Nginx模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装配置Nginx模块"><span class="toc-number">3.0.1.</span> <span class="toc-text">安装配置Nginx模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringBoot整合单机版FastDFS"><span class="toc-number">3.0.2.</span> <span class="toc-text">SpringBoot整合单机版FastDFS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#访问权限控制"><span class="toc-number">3.0.3.</span> <span class="toc-text">访问权限控制</span></a></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">整合单机版FastDFS</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-28</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/springboot/">springboot</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">81</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 1 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2019/09/28/springboot-22-union-one-fastDFS/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="FastDFS"><a href="#FastDFS" class="headerlink" title="FastDFS"></a>FastDFS</h1><h3 id="FastDFS简介"><a href="#FastDFS简介" class="headerlink" title="FastDFS简介"></a>FastDFS简介</h3><p>FastDFS是一个开源的高性能分布式文件系统（Distributed File System）。 它的主要功能包括文件存储、文件同步、文件访问，以及高容量和负载平衡。主要解决了海量数据的存储问题，非常适合以中小文件（建议范围：4KB < file_size <500MB）为载体的在线服务。</p>
<p>FastDFS支持Linux、FreeBSD等UNIX系统，很类似于Google FS（GFS），但不是通用的文件系统，只能通过专有的API进行访问，目前提供了C、Java和PHP等语言的API。FastDFS不仅可以解决大容量文件的存储问题，还对追求高性能和高扩展性的互联网行业提供了一种可行的解决方案。</p>
<h3 id="FastDFS架构"><a href="#FastDFS架构" class="headerlink" title="FastDFS架构"></a>FastDFS架构</h3><p>下面是一张来自FastDFS官网的系统架构图：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-ce33226ad9e416ed.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-ce33226ad9e416ed.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>从图中可以知道FastDFS架构包括Tracker Server和Storage Server两部分，其中Tracker Server是跟踪服务器，用来追踪文件，可以理解为文件的一个索引，而 Storage Server是存储服务器，用来保存文件。</p>
<p>开发者上传文件的文件最终保存在Storage Server中，文件的元数据信息保存在 Tracker Server上，通过Tracker Server可以实现对Storage Server的负载均衡。</p>
<p>一般的Storage Server会以集群的方式进行搭建，一个Storage Cluster可以由多个组构成，不同的组之间不能进行通信，一个组又相当于一个小的集群，组由多个Storage Server组成，组内的Storage Server会通过连接进行文件同步来保证系统的高可用。</p>
<p>因此我们可以得出结论：FastDFS主要有4个功能，文件上传、文件存储、文件同步以及文件下载。</p>
<h3 id="FastDFS的三种角色"><a href="#FastDFS的三种角色" class="headerlink" title="FastDFS的三种角色"></a>FastDFS的三种角色</h3><p>FastDFS有三个角色，分别是：跟踪服务器(Tracker Server)、存储服务器(Storage Server)和客户端(Client)。</p>
<p><strong>跟踪服务器(Tracker Server)。</strong>跟踪服务器，主要做调度工作，起负载均衡的作用。在内存中记录集群中所有存储服务器和存储组的状态信息，是客户端和数据服务器交互的枢纽。相比GFS中的master更为精简，它不记录文件索引信息，占用内存量很少。具体点就是负责管理所有的<code>存储服务器(Storage Server)</code>和<code>存储组(Storage Group)</code>，每个 Storage在启动后会连接Tracker，并告知自己所属组及其他信息，并保持周期性心跳。</p>
<p><strong>存储服务器(Storage Server)。</strong>存储服务器（又称存储节点或数据服务器），文件和文件属性（meta data）都保存到存储服务器上。存储服务器(Storage Server)直接利用操作系统的文件系统调用管理文件，主要提供容量和备份服务，以Group（组）为单位，每个Group内可以有多台存储服务器(Storage Server)，数据互为备份。</p>
<p><strong>客户端(Client)。</strong>客户端，一般作为业务请求的发起方，通过专有的API，使用TCP/IP协议与跟踪器服务器(Tracker Server)或存储节点(Storage Server)进行数据交互。FastDFS向使用者提供了文件的基本访问接口，如upload、download、append、delete等，以客户端库的方式提供给用户使用。一般而言，也称客户端为上传下载数据的服务器，即自己项目部署所在的服务器。</p>
<h3 id="FastDFS的存储策略"><a href="#FastDFS的存储策略" class="headerlink" title="FastDFS的存储策略"></a>FastDFS的存储策略</h3><p>为了支持大容量，存储节点(Storage Server)采用了分卷（或分组）的组织方式。存储系统由一个或多个卷组成，卷与卷之间的文件是相互独立的，所有卷的文件容量累加就是整个存储系统中的文件容量。一个卷可以由一台或多台存储服务器组成，一个卷下的存储服务器中的文件都是相同的，卷中的多台存储服务器起到了冗余备份和负载均衡的作用。</p>
<p>在卷中增加服务器时，系统会自动同步已有的文件，同步完成后，系统自动将新增服务器切换到线上提供服务。当存储空间不足或即将耗尽时，可以动态添加卷。只需要增加一台或多台服务器，并将它们配置为一个新的卷，这样就扩大了存储系统的容量。</p>
<h3 id="文件上传的内部机制"><a href="#文件上传的内部机制" class="headerlink" title="文件上传的内部机制"></a>文件上传的内部机制</h3><p>前面也说过FastDFS向使用者提供了文件的基本访问接口，如upload、download、append、delete等，以客户端库的方式提供给用户使用，所以用户根据提供的相应接口就能实现不同情况下的文件操作。</p>
<p>从下图中可以看出，<strong>存储服务器(Storage Server)</strong>会定期的向<strong>跟踪服务器(Tracker Server)</strong>发送自己的存储信息。当<code>Tracker Server Cluster</code>中的<code>Tracker Server</code>不止一个时，由于各个<code>Tracker Server</code>之间的关系是对等的，因此客户端上传时可以选择任意一个<code>Tracker Server</code>。</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-7141f95ce93852de.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-7141f95ce93852de.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>当客户端(Client)发起上传文件请求至<code>Tracker Server</code>，<code>Tracker Server</code>收到客户端上传文件的请求后，会去查询是否存在可用的<code>Storage Server</code>，如果存在则针对该请求返回一个可以存储文件的Group(里面包含了<code>Storage Server</code>的ip和端口等信息)，接着客户端向<code>Storage Server</code>发送上传文件请求，<code>Storage Server</code>将会为文件分配一个数据存储目录并且将文件内容写入磁盘，同时返回客户端file_id（里面包含路径、文件名等信息），最后客户端存储文件信息，这样文件上传流程就结束了。</p>
<p>客户端上传文件成功后，会得到一个由存储服务器(Storage Server)生成的信息（file_id），然后客户端可以根据该file_id来访问该文件。</p>
<h3 id="文件下载的内部机制"><a href="#文件下载的内部机制" class="headerlink" title="文件下载的内部机制"></a>文件下载的内部机制</h3><p>乍一看似乎前四步的操作和文件上传时的操作一致，其实不然，两者存在一些差别，主要就是第三步它是检测状态是否同步。然后第五步客户端(Client)发起携带file_id的请求至存储服务器(Storage Server)，存储服务器会根据file_id来查找是否存在相应的文件，若文件存在则返回file_content。</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-d408e93f1685fddf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-d408e93f1685fddf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<h3 id="文件同步的内部机制"><a href="#文件同步的内部机制" class="headerlink" title="文件同步的内部机制"></a>文件同步的内部机制</h3><p>在写文件的时候，客户端将文件写至Group内一个存储服务器中，即认为写文件操作成功，存储服务器写完文件后，会由后台线程将文件同步至同Group内其他的存储服务器。</p>
<p>每个存储服务器写文件后，同时会写一份binlog，binlog中不包含文件数据，只包含文件名等元信息，这份binlog用于后台同步，存储服务器会记录向Group内其他存储服务器同步的进度，以便重启后能接着上次的进度继续同步。注意进度以时间戳的方式进行记录，因此必须保证集群内所有存储服务器的时间保持同步。</p>
<p>存储服务器的同步进度会作为元数据的一部分汇报到跟踪服务器上，跟踪服务器在选择读取存储服务器的时候会以同步进度作为参考。</p>
<h1 id="单机版FastDFS"><a href="#单机版FastDFS" class="headerlink" title="单机版FastDFS"></a>单机版FastDFS</h1><h3 id="单机版FastDFS的安装"><a href="#单机版FastDFS的安装" class="headerlink" title="单机版FastDFS的安装"></a>单机版FastDFS的安装</h3><p><strong>第零步，安装环境检查。</strong>使用<code>yum install gcc libevent libevent-devel -y</code>来检查安装环境中各依赖是否存在，不存在就直接安装即可。<br><strong>第一步，下载安装libfastcommon。</strong>libfastcommon是从FastDFS和FastDHT中提取出来的公共C函数库，它是FastDFS安装的基础依赖，首先需要安装它，相应的步骤如下：（注意笔者所有的软件都下载在<code>/home/soft</code>目录下）<br>（1）下载libfastcommon。使用如下命令来下载最新版的libfastcommon，版本为V1.0.36：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/happyfish100/libfastcommon/archive/V1.0.36.tar.gz</span><br></pre></td></tr></tbody></table></figure></div>
<p>（2）解压安装包。使用如下命令来解压下载的libfastcommon安装包：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf V1.0.36.tar.gz</span><br></pre></td></tr></tbody></table></figure></div>
<p>（3）编译和安装。注意<code>V1.0.36.tar.gz</code>解压后得到的文件夹名称为<code>libfastcommon-1.0.36</code>，然后进入该文件夹中开始编译和安装操作：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd libfastcommon-1.0.36</span><br><span class="line">./make.sh</span><br><span class="line">./make.sh install</span><br></pre></td></tr></tbody></table></figure></div>
<p>这样关于libfastcommon的安装就完成了。<br><strong>第二步，下载安装FastDFS。</strong>在安装完libfastcommon之后，接下来开始安装FastDFS，相应的步骤如下：<br>（1）下载FastDFS。使用如下命令来下载最新版的FastDFS，版本为V5.11：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/happyfish100/fastdfs/archive/V5.11.tar.gz</span><br></pre></td></tr></tbody></table></figure></div>
<p>（2）解压安装包。使用如下命令来解压下载的FastDFS安装包：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf V5.11.tar.gz</span><br></pre></td></tr></tbody></table></figure></div>
<p>（3）编译和安装。注意<code>V5.11.tar.gz</code>解压后得到的文件夹名称为<code>fastdfs-5.11</code>，然后进入该文件夹中开始编译和安装操作：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd fastdfs-5.11</span><br><span class="line">./make.sh</span><br><span class="line">./make.sh install</span><br></pre></td></tr></tbody></table></figure></div>
<p>如果出现没有perl的情况，请使用<code>yum -y install perl</code>命令进行安装。至此FastDFS安装完成，安装后所有编译出来的文件存放在<code>/usr/bin</code>目录下，所有配置文件存放在<code>/etc/fdfs</code>目录下； 可使用<code>ll /usr/bin/fdfs*</code>命令进行查看。不过笔者还是觉得有必要详细介绍FDFS相关文档信息，于是第四步就开始进行说明。<br>（4）使用默认安装方式安装后的相应文件与目录说明。<br>A、服务脚本：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/fdfs_storaged</span><br><span class="line">/etc/init.d/fdfs_tracker</span><br></pre></td></tr></tbody></table></figure></div>
<p>B、配置文件（注意下面四个是样例配置文件） :</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/fdfs/client.conf.sample</span><br><span class="line">/etc/fdfs/storage.conf.sample</span><br><span class="line">/etc/fdfs/storage_ids.conf.sample</span><br><span class="line">/etc/fdfs/tracker.conf.sample</span><br></pre></td></tr></tbody></table></figure></div>
<p>C、fdfs相关命令工具存在于<code>/usr/bin/</code>目录下，可以使用<code>ll /usr/bin/fdfs*</code>命令进行查看：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fdfs_appender_test       </span><br><span class="line">fdfs_appender_test1                </span><br><span class="line">fdfs_append_file   </span><br><span class="line">fdfs_crc32     </span><br><span class="line">fdfs_delete_file               </span><br><span class="line">fdfs_download_file</span><br><span class="line">fdfs_file_info          </span><br><span class="line">fdfs_monitor             </span><br><span class="line">fdfs_regenerate_filename</span><br><span class="line">fdfs_test          </span><br><span class="line">fdfs_test1</span><br><span class="line">fdfs_trackerd        </span><br><span class="line">fdfs_upload_appender</span><br><span class="line">fdfs_upload_file</span><br><span class="line">stop.sh</span><br><span class="line">restart.sh</span><br></pre></td></tr></tbody></table></figure></div>
<p><strong>（5）注意这一步是专门针对<code>V5.0</code>版本而言的，如果使用的是<code>V5.11</code>及以上版本，可以跳过本步骤，因为它本身脚本中设置的目录就是<code>/usr/bin/</code>目录。</strong>如下图所示：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-c7d2973ace1cc45f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-c7d2973ace1cc45f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>在<code>V5.0</code>版本中FastDFS服务脚本设置的bin目录是<code>/usr/local/bin</code>，但实际命令却存在于<code>/usr/bin/</code>目录下，因此需要进行修改，这里提供两种修改方式：<br>方法1：修改FastDFS服务脚本设置的bin目录，将其由<code>/usr/local/bin</code>修改为<code>/usr/bin/</code>，这是比较快捷的做法，但并不推荐这样操作。在第4步中介绍了fdfs的两个服务脚本：<code>fdfs_storaged</code>和<code>fdfs_tracker</code>，它们均存在于<code>/etc/init.d/</code>目录中。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># vim fdfs_trackerd</span><br><span class="line">使用查找替换命令进统一修改:%s+/usr/local/bin+/usr/bin</span><br><span class="line"># vim fdfs_storaged</span><br><span class="line">使用查找替换命令进统一修改:%s+/usr/local/bin+/usr/bin</span><br></pre></td></tr></tbody></table></figure></div>
<p>方法2：使用软链接，建立<code>/usr/bin</code>到<code>/usr/local/bin</code>的软链接，推荐使用这种做法：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/bin/fdfs_trackerd   /usr/local/bin</span><br><span class="line">ln -s /usr/bin/fdfs_storaged   /usr/local/bin</span><br><span class="line">ln -s /usr/bin/stop.sh         /usr/local/bin</span><br><span class="line">ln -s /usr/bin/restart.sh      /usr/local/bin</span><br></pre></td></tr></tbody></table></figure></div>
<p><strong>第三步，配置FastDFS跟踪器(Tracker)。</strong>关于FastDFS跟踪器配置文件的详细说明，请阅读另一篇文章，或者点击 <a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&tid=1941456&extra=page%3D1%26filter%3Ddigest%26digest%3D1" target="_blank" rel="noopener">这里</a>。接下来就开始进行跟踪器的配置：<br>（1）进入<code>/etc/fdfs</code>目录下(因为四个例配置文件就存在与该目录)，复制FDFS跟踪器样例配置文件<code>tracker.conf.sample</code>，并重命名为<code>tracker.conf</code>，使用的命令如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/fdfs</span><br><span class="line">cp tracker.conf.sample tracker.conf</span><br><span class="line">vi tracker.conf</span><br></pre></td></tr></tbody></table></figure></div>
<p>（2）编辑<code>tracker.conf</code>，修改以下两项配置，其它的使用默认即可：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Tracker 数据和日志目录地址(根目录必须存在，子目录会自动创建)</span><br><span class="line">base_path=/home/envy/fastdfs/tracker</span><br><span class="line"># HTTP 服务端口</span><br><span class="line">http.server_port=80</span><br></pre></td></tr></tbody></table></figure></div>
<p>（3） 创建tracker基础数据目录，也就是base_path对应的目录：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/envy/fastdfs/tracker</span><br></pre></td></tr></tbody></table></figure></div>
<p>（4）打开防火墙中的跟踪端口号（默认为22122），当然笔者是直接把防火墙给关闭了，因此这一步可以不用设置。<br>（5）启动Tracker，初次成功启动后，会自动在<code>/home/envy/fastdfs/tracker</code>(即前面配置的base_path)目录下创建data和logs这两个目录。启动方式有两种：第一种，使用启动脚本：<code>/etc/init.d/fdfs_trackerd start</code>；第二种使用系统服务方式<code>service fdfs_trackerd start</code>。</p>
<p>为了验证<code>FastDFS Tracker</code>是否已成功启动，只需要监听22122端口是否被使用，如果已显示被占用，则表明Tracker服务安装并启动成功：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost envy]# lsof -i :22122</span><br><span class="line">COMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">fdfs_trac 11629 root    5u  IPv4  57965      0t0  TCP *:22122 (LISTEN)</span><br></pre></td></tr></tbody></table></figure></div>
<p>也可以使用<code>netstat -unltp|grep fdfs</code>命令来进行查看，如果提示netstat不存在，则可以使用<code>yum -y install net-tools</code>命令来安装该工具：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost fdfs]#  netstat -unltp|grep fdfs</span><br><span class="line">tcp        0      0 0.0.0.0:22122           0.0.0.0:*               LISTEN      16499/fdfs_trackerd</span><br></pre></td></tr></tbody></table></figure></div>
<p>还可以使用<code>ps -ef|grep fdfs</code>命令来查看fdfs程序的运行状况。如果你想关闭Tracker，可以使用<code>service fdfs_trackerd stop</code>命令。</p>
<p>（6）设置Tracker开机自启动。开发者可通过两种方式来配置Tracker开机自启动，第一种方式就是使用<code>chkconfig fdfs_trackerd on</code>；第二种方式就是将其添加到系统启动脚本中，使用<code>vim /etc/rc.d/rc.local</code>命令来打开该文件，并在其中添加如下一行代码<code>/etc/init.d/fdfs_trackerd start</code>，如此就完成了Tracker的开机自启动设置。</p>
<p>（7）<code>tracker server</code>目录及文件结构。第五步表明当Tracker初次成功启动后，会自动在<code>/home/envy/fastdfs/tracker</code>(即前面配置的base_path)目录下创建data和logs这两个目录，将下来就查看该文件目录：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">envy</span><br><span class="line">└── fastdfs</span><br><span class="line">    └── tracker</span><br><span class="line">        ├── data</span><br><span class="line">        │   ├── fdfs_trackerd.pid  跟踪器进程信息</span><br><span class="line">        │   └── storage_changelog.dat  存储改变日志记录文件</span><br><span class="line">        └── logs</span><br><span class="line">            └── trackerd.log  tracker server日志文件</span><br></pre></td></tr></tbody></table></figure></div>
<p><strong>第四步，配置FastDFS存储 (Storage)。</strong>这个存储服务器的设置和跟踪服务器的设置过程非常相似。<br>（1）进入<code>/etc/fdfs</code>目录下，复制FDFS存储器样例配置文件<code>storage.conf.sample</code>，并重命名为<code>storage.conf</code>，使用的命令如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/fdfs</span><br><span class="line">cp storage.conf.sample storage.conf</span><br><span class="line">vi storage.conf</span><br></pre></td></tr></tbody></table></figure></div>
<p>（2）编辑<code>storage.conf</code>，修改以下四项配置，其它的使用默认即可：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Storage数据和日志目录地址(根目录必须存在，子目录会自动生成)</span><br><span class="line">base_path=/home/envy/fastdfs/storage</span><br><span class="line"></span><br><span class="line"># 逐一配置store_path_count的路径，索引号从0开始。</span><br><span class="line"># 如果不配置store_path0，那它就和base_path对应的路径一样。</span><br><span class="line">store_path0=/home/envy/fastdfs/file</span><br><span class="line"></span><br><span class="line"># tracker_server的列表，会主动连接tracker_server</span><br><span class="line"># 当存在多个tracker server时，每个tracker server写一行</span><br><span class="line">tracker_server=192.168.2.132:22122</span><br><span class="line"></span><br><span class="line"># 访问端口</span><br><span class="line">http.server_port=80</span><br></pre></td></tr></tbody></table></figure></div>
<p>（3） 创建Storage和文件基础数据目录，也就是base_path和store_path0对应的目录：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/envy/fastdfs/storage</span><br><span class="line">mkdir -p /home/envy/fastdfs/file</span><br></pre></td></tr></tbody></table></figure></div>
<p>（4）打开防火墙中的存储端口号（默认为23000），当然笔者是直接把防火墙给关闭了，因此这一步可以不用设置。</p>
<p>（5）启动Storage。在Storage启动前，请确保已经成功启动了Tracker，同样Storage初次成功启动后，会自动在<code>/home/envy/fastdfs/storage</code>(即前面配置的base_path)目录下创建data和logs这两个目录。启动方式有两种：第一种，使用启动脚本：<code>/etc/init.d/fdfs_storaged start</code>；第二种使用系统服务方式<code>service fdfs_storaged start</code>（推荐使用这种）。</p>
<p>为了验证<code>FastDFS Storage</code>是否已成功启动，只需要监听23000端口是否被使用，如果已显示被占用，则表明Tracker服务安装并启动成功：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost fdfs]# lsof -i :23000</span><br><span class="line">COMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">fdfs_stor 18632 root    5u  IPv4  73224      0t0  TCP *:inovaport1 (LISTEN)</span><br></pre></td></tr></tbody></table></figure></div>
<p>也可以使用<code>netstat -unltp|grep fdfs</code>命令来进行查看：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost fdfs]#  netstat -unltp|grep fdfs</span><br><span class="line">tcp        0      0 0.0.0.0:23000           0.0.0.0:*               LISTEN      18632/fdfs_storaged </span><br><span class="line">tcp        0      0 0.0.0.0:22122           0.0.0.0:*               LISTEN      16499/fdfs_trackerd</span><br></pre></td></tr></tbody></table></figure></div>
<p>还可以使用<code>ps -ef|grep fdfs</code>命令来查看fdfs程序的运行状况。如果你想关闭Storage，可以使用<code>service fdfs_storaged stop</code>命令。</p>
<p>（6）查看Storage和Tracker是否在通信。使用如下命令<code>/usr/bin/fdfs_monitor /etc/fdfs/storage.conf</code>来查看Storage和Tracker是否在通信：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-7a03c78af20acfab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-7a03c78af20acfab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>（7）设置Storage开机自启动。开发者可通过两种方式来配置Storage开机自启动，第一种方式就是使用<code>chkconfig fdfs_storaged on</code>；第二种方式就是将其添加到系统启动脚本中，使用<code>vi /etc/rc.d/rc.local</code>命令来打开该文件，并在其中添加如下一行代码<code>/etc/init.d/fdfs_storaged start</code>，如此就完成了Storage的开机自启动设置。</p>
<p>（8）<code>storage server</code>目录及文件结构。第五步表明当Storage初次成功启动后，会自动在<code>/home/envy/fastdfs/storage</code>(即前面配置的base_path)目录下创建data和logs这两个目录，将下来就查看该文件目录：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">├── storage</span><br><span class="line">│   ├── data</span><br><span class="line">│   │   ├── fdfs_storaged.pid</span><br><span class="line">│   │   ├── storage_stat.dat</span><br><span class="line">│   │   └── sync</span><br><span class="line">│   │       ├── binlog.000</span><br><span class="line">│   │       └── binlog.index</span><br><span class="line">│   └── logs</span><br><span class="line">│       └── storaged.log</span><br><span class="line">└── tracker</span><br><span class="line">    ├── data</span><br><span class="line">    │   ├── fdfs_trackerd.pid</span><br><span class="line">    │   ├── storage_changelog.dat</span><br><span class="line">    │   ├── storage_groups_new.dat</span><br><span class="line">    │   ├── storage_servers_new.dat</span><br><span class="line">    │   └── storage_sync_timestamp.dat</span><br><span class="line">    └── logs</span><br><span class="line">        └── trackerd.log</span><br></pre></td></tr></tbody></table></figure></div>
<p>可以看到随着Storage的启动，Tracker的数据也发生了变化，最重要的是在<code>/home/envy/fastdfs/file/data</code>目录下自动创建了N*N个文件夹：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-79866f402f6b2c99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-79866f402f6b2c99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p><strong>第五步，文件上传测试。</strong>接下来开始尝试进行文件上传的测试，相应的步骤如下：<br>（1）修改<code>Tracker Server</code>跟踪服务器中客户端的配置文件。进入<code>/etc/fdfs</code>目录下，复制FDFS存储器样例配置文件<code>storage.conf.sample</code>，并重命名为<code>storage.conf</code>，使用的命令如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/fdfs</span><br><span class="line">cp client.conf.sample client.conf</span><br><span class="line">vi client.conf</span><br></pre></td></tr></tbody></table></figure></div>
<p>（2）编辑<code>client.conf</code>，修改以下两项配置，其它的使用默认即可：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Client客户端的数据和日志目录</span><br><span class="line">base_path=/home/envy/fastdfs/client</span><br><span class="line"></span><br><span class="line"># Tracker Server端口</span><br><span class="line">tracker_server=192.168.2.132:22122</span><br></pre></td></tr></tbody></table></figure></div>
<p>（3） 创建client基础数据目录，也就是base_path对应的目录：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/envy/fastdfs/client</span><br></pre></td></tr></tbody></table></figure></div>
<p>（4）开始测试文件上传。在CentOS系统中任意一个地方执行如下命令来上传<code>avatar.jpg</code>图片，请注意这个<code>avatar.jpg</code>图片事前笔者放在了<code>/root</code>目录下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/fdfs_upload_file /etc/fdfs/client.conf /root/avatar.jpg</span><br></pre></td></tr></tbody></table></figure></div>
<p>可以看到执行后的结果为：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-2f2e476f0f3ae022.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-2f2e476f0f3ae022.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>也就是返回了一串信息，其实这就是文件的ID：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">group1/M00/00/00/wKgChF7aCZeAZCfOAAA5HlXZsUI176.jpg</span><br></pre></td></tr></tbody></table></figure></div>
<p>文件ID由group、存储目录、二级子目录、fileid、文件后缀名（由客户端指定，主要用于区分文件类型）拼接而成。</p>
<h3 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h3><p>虽然前面已经将文件成功上传了，但是到目前为止还无法访问和下载，因此考虑使用Nginx作为服务器并以http请求的方式来访问和下载文件。实际上后面安装FastDFS的Nginx模块时也需要Nginx环境，因此这里提前安装Nginx。</p>
<p>由于是访问和下载文件，因此Nginx可以直接和StorageServer部署在同一台服务器即可，且此处是单机版FastDFS，所以将<code>TrackerServer</code>、<code>StorageServer</code>和<code>Nginx</code>都部署在一台服务器上。</p>
<p><strong>第一步，安装Nginx依赖环境。</strong>直接使用如下命令来安装Nginx依赖环境：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br></pre></td></tr></tbody></table></figure></div>
<p><strong>第二步，下载编译安装Nginx。</strong>依次执行如下命令：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://nginx.org/download/nginx-1.18.0.tar.gz</span><br><span class="line">tar -zxvf nginx-1.18.0.tar.gz</span><br><span class="line">cd nginx-1.18.0</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></tbody></table></figure></div>
<p>接着启动Nginx，启动Nginx有两种方法：第一种使用<code>cd /usr/local/nginx/sbin/</code>命令进入到脚本文件所在目录，然后执行<code>./nginx</code>即可启动；第二种，使用系统服务方式<code>systemctl start nginx</code>或者是<code>service nginx start</code>命令来启动。这里提供一下针对第一种启动方式的其他命令：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ./nginx -s start（强制启动）</span><br><span class="line"># ./nginx -s stop（强制停止）</span><br><span class="line"># ./nginx -s quit（强制退出）</span><br><span class="line"># ./nginx -s reload（强制重启）</span><br></pre></td></tr></tbody></table></figure></div>
<p>接下来设置nginx的开启自启动，也是有两种方式：第一种方式就是使用<code>chkconfig nginx on</code>；第二种方式就是将其添加到系统启动脚本中，使用<code>vi /etc/rc.local</code>命令来打开该文件，并在其中添加如下一行代码<code>/usr/local/nginx/sbin/nginx</code>，同时使用<code>chmod 755 rc.local</code>命令来赋予该文件755权限，如此就完成了Nginx的开机自启动设置。</p>
<p><strong>第三步，开放80端口。</strong>打开防火墙中的Nginx端口号（默认为80），当然笔者是直接把防火墙给关闭了，因此这一步可以不用设置。注意笔者此处已经有一个项目占据了80端口，因此这里使用81端口。</p>
<p><strong>第四步，访问文件。</strong>首先需要修改<code>nginx.conf</code>配置文件，使用<code>vi /usr/local/nginx/conf/nginx.conf</code>命令来打开该文件，然后往里面新增如下信息，用于将<code>/group1/M00</code>映射到<code>/home/envy/fastdfs/file/data</code>目录。注意由于笔者默认的<code>default.conf</code>已经使用了，因此这里新建一个<code>file.envy.com.conf</code>配置文件，请注意该命令就是server_name，此时里面的代码为：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server {</span><br><span class="line">    listen   81;</span><br><span class="line">    server_name  file.envy.com;</span><br><span class="line"></span><br><span class="line">    location /group1/M00 {</span><br><span class="line">        alias  /home/envy/fastdfs/file/data;</span><br><span class="line">        autoindex on;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>之后使用<code>/usr/local/nginx/sbin/nginx -s reload</code>命令来强制重启Nginx，然后在浏览器中访问<code>http://file.envy.com:81/group1/M00/00/00/wKgChF7aCZeAZCfOAAA5HlXZsUI176.jpg</code>链接即可查看到该照片，注意想使用域名访问，则必须打开本地Windows电脑上的<code>C:\Windows\System32\drivers\etc\hosts</code>文件，新增如下一行代码：<code>192.168.2.132 file.envy.com</code>：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-e974749c12b101e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-e974749c12b101e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<h1 id="FastDFS配置Nginx模块"><a href="#FastDFS配置Nginx模块" class="headerlink" title="FastDFS配置Nginx模块"></a>FastDFS配置Nginx模块</h1><h3 id="安装配置Nginx模块"><a href="#安装配置Nginx模块" class="headerlink" title="安装配置Nginx模块"></a>安装配置Nginx模块</h3><p>（1）<code>fastdfs-nginx-module</code>模块介绍。<br>通过前面的学习，大家知道了FastDFS是通过 Tracker Server跟踪服务器将文件放在 Storage Server存储服务器进行存储， 但是同组Storage Server存储服务器之间需要进行文件复制， 会存在同步延迟的问题。举个例子来说，假设Tracker Server跟踪服务器将文件上传到了IP为192.168.2.132的Storage Server存储服务器，且上传成功后已经将文件ID返回给客户端。注意此时FastDFS存储集群机制会将这个文件同步到同组IP为192.168.2.133的存储服务器上，在文件还没有复制完成的情况下，此时客户端如果是用这个文件ID去IP为192.168.2.133的存储服务器上取文件，就会出现文件无法访问的异常错误情况。而<code>fastdfs-nginx-module</code>的存在可以避免客户端由于复制延迟而导致的文件无法访问异常错误，那是因为它可以重定向文件链接到源服务器进而获取相应的资源文件。<br>（2）下载、解压<code>fastdfs-nginx-module</code>模块。依次执行如下命令来下载、解压<code>fastdfs-nginx-module</code>模块：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/happyfish100/fastdfs-nginx-module/archive/V1.20.tar.gz</span><br><span class="line">tar -zxvf V1.20.tar.gz </span><br><span class="line">cd fastdfs-nginx-module-1.20/</span><br></pre></td></tr></tbody></table></figure></div>
<p>（3）配置Nginx。现在需要停掉正在运行的Nginx，并在其中添加<code>fastdfs-nginx-module</code>模块，相应的步骤如下，按照步骤来即可（注意nginx的安装方式必须是源码安装而不是yum安装）：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 停掉nginx服务</span><br><span class="line">/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line"># 验证nginx已经停止服务</span><br><span class="line">ps -ef|grep nginx</span><br><span class="line"># 进入nginx的解压包目录（每个人的目录不一样）</span><br><span class="line">/home/soft/nginx-1.18.0</span><br><span class="line"># 添加fastdfs-nginx-module-1.20模块（每个人的目录不一样）</span><br><span class="line">./configure --add-module=/home/soft/fastdfs-nginx-module-1.20/src</span><br><span class="line"># 重新编译、安装</span><br><span class="line">make && make install</span><br></pre></td></tr></tbody></table></figure></div>
<p>如果在编译阶段出现下面的错误：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/include/fastdfs/fdfs_define.h:15:27: 致命错误：common_define.h：没有那个文件或目录</span><br></pre></td></tr></tbody></table></figure></div>
<p>只需要编辑<code>fastdfs-nginx-module-1.20/src/config</code>文件，然后将下面两行代码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ngx_module_incs="/usr/local/include"</span><br><span class="line">CORE_INCS="$CORE_INCS /usr/local/include"</span><br></pre></td></tr></tbody></table></figure></div>
<p>修改为以下信息：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ngx_module_incs="/usr/include/fastdfs /usr/include/fastcommon/"</span><br><span class="line">CORE_INCS="$CORE_INCS /usr/include/fastdfs /usr/include/fastcommon/"</span><br></pre></td></tr></tbody></table></figure></div>
<p>然后继续执行<code>./configure --add-module=/home/soft/fastdfs-nginx-module-1.20/src</code>以及编译安装命令即可。<br>（4）查看Nginx的模块。接下来使用<code>/usr/local/nginx/sbin/nginx -V</code>命令来查看<code>fastdfs-nginx-module</code>模块是否已经成功添加入Nginx：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf]# /usr/local/nginx/sbin/nginx -V</span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class="line">configure arguments: --add-module=/home/soft/fastdfs-nginx-module-1.20/src</span><br></pre></td></tr></tbody></table></figure></div>
<p>出现上述结果表明该模块已经成功添加到Nginx中。<br>（5）复制并修改配置文件。将<code>fastdfs-nginx-module</code>源码中的<code>mod_fastdfs.conf</code>配置文件复制到<code>/etc/fdfs</code>目录，使用的命令为：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /home/soft/fastdfs-nginx-module-1.20/src/mod_fastdfs.conf /etc/fdfs/</span><br></pre></td></tr></tbody></table></figure></div>
<p>接着修改<code>/etc/fdfs/mod_fastdfs.conf</code>配置文件：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 连接超时时间</span><br><span class="line">connect_timeout=10</span><br><span class="line"># 设置Tracker Server地址</span><br><span class="line">tracker_server=file.envy.com:22122</span><br><span class="line"># StorageServer 默认端口23000</span><br><span class="line">storage_server_port=23000</span><br><span class="line"># 如果文件ID的URL中包含/group**，则要设置为true</span><br><span class="line">url_have_group_name = true</span><br><span class="line"># 此项为storage server中配置的store_path0路径</span><br><span class="line">store_path0=/home/envy/fastdfs/file</span><br></pre></td></tr></tbody></table></figure></div>
<p>（6）复制FastDFS安装包内的部分配置文件到<code>/etc/fdfs</code>目录中，使用的命令为：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /home/soft/fastdfs-5.11/conf</span><br><span class="line">cp anti-steal.jpg http.conf mime.types /etc/fdfs/</span><br></pre></td></tr></tbody></table></figure></div>
<p>（7）修改Nginx的配置文件<code>nginx.conf</code>，注意笔者nginx的运行脚本目录为<code>/usr/local/nginx/sbin/nginx</code>，但是配置文件目录却在<code>/usr/local/nginx/conf/conf.d</code>下，最主要的是所有Nginx的配置信息都在一个名为<code>file.envy.com.conf</code>的配置文件中，打开它，新增如下代码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~/group([0-9])/M00 {</span><br><span class="line">      ngx_fastdfs_module;</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure></div>
<p>接着将前面的group1的映射关系给注释掉：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-e34cecb7291ed4be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-e34cecb7291ed4be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>这里有两点需要注意的地方：（1）由于笔者此处listen监听的端口值为81，因此需要将<code>/etc/fdfs/storage.conf</code>中的<code>http.server_port=80</code>修改为81端口，两者必须保持一致，且同时在防火墙开放该端口的访问权限。（2）注意一下<code>location</code>的配置，如果有多个group则需要配置<code>location ~ /group([0-9])/M00</code>，没有则不用配group，不过笔者建议还是配置group为好。</p>
<p>（8）重新启动FDFS和Nginx。依次使用如下命令来重新启动FDFS和Nginx：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service fdfs_trackerd stop</span><br><span class="line">service fdfs_storaged stop</span><br><span class="line">service fdfs_trackerd start</span><br><span class="line">service fdfs_storaged start</span><br></pre></td></tr></tbody></table></figure></div>
<p>接着进入到<code>/usr/local/nginx/sbin/nginx</code>目录中，执行<code>./nginx</code>命令来启动nginx，如果出现下图所示的信息，则表明nginx中添加<code>fastdfs-nginx-module</code>模块的配置就成功了：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-c438604eec923a12.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-c438604eec923a12.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>（9）访问资源。在浏览器中访问<code>http://file.envy.com:81/group1/M00/00/00/wKgChF7aCZeAZCfOAAA5HlXZsUI176.jpg</code>链接即可查看到该照片：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-e974749c12b101e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-e974749c12b101e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>请注意这里和前面直接使用nginx路由进行访问的方式是不同的，这里配置了<code>fastdfs-nginx-module</code>模块，该模块可以重定向文件链接到源服务器进而来获取文件，这里并没有在nginx中配置资源访问路径这一点要引起格外注意。</p>
<p>接下来通过一张图来总结本次单机版FastDFS的整合架构图：（图片来源未知）</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-38426cd9eb3d22aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-38426cd9eb3d22aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<h3 id="SpringBoot整合单机版FastDFS"><a href="#SpringBoot整合单机版FastDFS" class="headerlink" title="SpringBoot整合单机版FastDFS"></a>SpringBoot整合单机版FastDFS</h3><p><strong>第一步，创建项目。</strong>使用<code>spring Initializr</code>构建工具构建一个SpringBoot的Web应用，名称为<code>fastdfsonesb</code>，然后在pom.xml文件中添加如下依赖：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><!--添加fastdfs依赖--></span><br><span class="line"><dependency></dependency></span><br><span class="line">    <groupid>net.oschina.zcx7878</groupid></span><br><span class="line">    <artifactid>fastdfs-client-java</artifactid></span><br><span class="line">    <version>1.27.0.0</version></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>
<p><strong>第二步，修改fastdfs配置文件。</strong>接下来修改fastdfs配置文件<code>fastdfs-client.properties</code>或者<code>fdfs_client.conf</code>（二选一即可），开发者可以点击 <a href="https://github.com/happyfish100/fastdfs-client-java" target="_blank" rel="noopener">这里</a>，或者在IDEA左侧的源码包中点击<code>fastdfs-client</code>安装包：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-0d5942b40ce0dec1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-0d5942b40ce0dec1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>复制图中所示的<code>fastdfs-client.properties.sample</code>或者<code>fdfs_client.conf.sample</code>文件至开发者自己的项目中，并去掉<code>.sample</code>后缀，笔者选择了复制<code>fastdfs-client.properties.sample</code>文件并修改后缀的方式，注意修改后的<code>fastdfs-client.properties</code>文件存放于classpath路径下，也就是项目配置文件同级目录，该文件中有关<code>connection_pool</code>的配置则摘自FastDFS官方说明文档：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fastdfs.connect_timeout_in_seconds = 5</span><br><span class="line">fastdfs.network_timeout_in_seconds = 30</span><br><span class="line"></span><br><span class="line">fastdfs.charset = UTF-8</span><br><span class="line"></span><br><span class="line">fastdfs.http_anti_steal_token = false</span><br><span class="line">fastdfs.http_secret_key = FastDFS1234567890</span><br><span class="line">fastdfs.http_tracker_http_port = 80</span><br><span class="line"></span><br><span class="line">fastdfs.tracker_servers = file.envy.com:22122</span><br><span class="line"></span><br><span class="line">connection_pool.enabled = true</span><br><span class="line">connection_pool.max_count_per_entry = 500</span><br><span class="line">connection_pool.max_idle_time = 3600</span><br><span class="line">connection_pool.max_wait_time_in_ms = 1000</span><br></pre></td></tr></tbody></table></figure></div>
<p>注意笔者只是将<code>fastdfs.tracker_servers</code>的值进行了修改，其余使用了默认信息，获取更多配置信息，可以点击 <a href="https://github.com/happyfish100/fastdfs-client-java" target="_blank" rel="noopener">这里</a>。</p>
<p><strong>第三步，新建一个test包，开始测试文件上传功能。</strong>新建一个test包，并在其中新建一个<code>EnvyFastdfsTest</code>测试类，用于书写测试代码。官方文档提示首先需要加载配置项：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-39d74a4b4602cb0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-39d74a4b4602cb0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>其他的就是文件上传的通用写法：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void testFileUpload() {</span><br><span class="line">    try {</span><br><span class="line">        ClientGlobal.initByProperties("fastdfs-client.properties");</span><br><span class="line">        TrackerClient tracker = new TrackerClient();</span><br><span class="line">        TrackerServer trackerServer = tracker.getConnection();</span><br><span class="line">        StorageServer storageServer = null;</span><br><span class="line">        StorageClient1 client =new StorageClient1(trackerServer,storageServer);</span><br><span class="line"></span><br><span class="line">        NameValuePair[] nameValuePairs = null;</span><br><span class="line"></span><br><span class="line">        String fileId = client.upload_file1("C:\\Users\\Administrator\\Desktop\\ant.jpg","jpg",nameValuePairs);</span><br><span class="line">        System.out.println(fileId);</span><br><span class="line"></span><br><span class="line">    } catch (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>简单解释一下上述代码的含义：首先加载配置文件，然后构造一个TrackerClient对象，接着再根据这个对象获取到一个TrackerServer，然后创建一个StorageClient1实例。NameValuePair中保存的是文件的元数据信息，如果存在，就以key/value形式进行设置，如果不存在，设置一个null即可。最后调用client的upload_file1方法来上传文件，该方法第一个参数是文件的路径，第二个参数是文件的扩展名，第三个参数是文件的元数据信息。upload_file1方法的返回值是文件的fileId，即上传文件的访问路径。因此当运行该方法后，程序控制台会输出以下信息；</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">group1/M00/00/00/wKgChF7cTG6AO5ciAABkkg-s-zw858.jpg</span><br></pre></td></tr></tbody></table></figure></div>
<p>接着打开浏览器，在地址栏中输入以下链接<code>http://file.envy.com:81/group1/M00/00/00/wKgChF7cTG6AO5ciAABkkg-s-zw858.jpg</code>，访问它即可查看到该照片：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-bd3df8780ea035f3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-bd3df8780ea035f3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>其实storage server服务器上也是存在该照片的，可以验证一下：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-b501eedbc000229b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-b501eedbc000229b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p><strong>第四步，测试文件下载功能。</strong>在<code>EnvyFastdfsTest</code>测试类中书写文件下载的业务逻辑：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public void testFileDownload(){</span><br><span class="line">    try {</span><br><span class="line">        ClientGlobal.initByProperties("fastdfs-client.properties");</span><br><span class="line">        TrackerClient tracker = new TrackerClient();</span><br><span class="line">        TrackerServer trackerServer = tracker.getConnection();</span><br><span class="line">        StorageServer storageServer = null;</span><br><span class="line">        StorageClient1 client =new StorageClient1(trackerServer,storageServer);</span><br><span class="line"></span><br><span class="line">        //得到file_id的字节数组</span><br><span class="line">        byte[] bytes = client.download_file1("group1/M00/00/00/wKgChF7cTG6AO5ciAABkkg-s-zw858.jpg");</span><br><span class="line"></span><br><span class="line">        //设置本地保存路径</span><br><span class="line">        FileOutputStream fos = new FileOutputStream(new File("C:\\Users\\Administrator\\Desktop\\newAnt.jpg"));</span><br><span class="line">        fos.write(bytes);</span><br><span class="line">        fos.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    } catch (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>前面五行代码和上传功能一致，然后调用download_file1方法得到一个byte数组，然后通过IO流写出到本地文件，这样本地就生成了一个待下载文件。</p>
<p><strong>第五步，测试文件删除功能。</strong>在<code>EnvyFastdfsTest</code>测试类中书写文件删除的业务逻辑：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void testFileDelete(){</span><br><span class="line">        try {</span><br><span class="line">            ClientGlobal.initByProperties("fastdfs-client.properties");</span><br><span class="line">            TrackerClient tracker = new TrackerClient();</span><br><span class="line">            TrackerServer trackerServer = tracker.getConnection();</span><br><span class="line">            StorageServer storageServer = null;</span><br><span class="line">            StorageClient1 client =new StorageClient1(trackerServer,storageServer);</span><br><span class="line"></span><br><span class="line">            //得到file_id的字节数组</span><br><span class="line">            int result =client.delete_file1("group1/M00/00/00/wKgChF7cS_mAHTyKAAA5HlXZsUI458.jpg");</span><br><span class="line">            System.out.println(result);</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>
<p>前面五行代码依然不变，后面通过调用delete_file1方法，传入待删除文件的file_id，注意该方法返回的是一个int类型的变量，如果为0则表示删除成功，反之删除失败。运行一下该方法，可以看到控制台输出0。然后查看一下storage server存储服务器上的存储信息，如下图所示：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-46a46df161eba9cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-46a46df161eba9cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<h3 id="访问权限控制"><a href="#访问权限控制" class="headerlink" title="访问权限控制"></a>访问权限控制</h3><p>请注意前面的设置使得所有人都能直接访问这个文件服务器，这肯定不是我们想看看到的情况，因此需要进行访问权限设置。</p>
<p>FastDFS的权限控制是在服务端开启token验证，然后客户端根据文件名、当前unix时间戳、秘钥来获取token，最终在地址中以携带token参数的http请求方式来访问对应的文件。</p>
<p><strong>第一步，服务端开启token验证。</strong>使用<code>cd /etc/fdfs</code>命令进入到配置文件目录，接着使用<code>vi http.conf</code>打开http配置文件，修改下图的4个信息：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-1d58cc0ff9685baf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-1d58cc0ff9685baf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>修改为以下配置：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 设置true表示开启token验证</span><br><span class="line">http.anti_steal.check_token=true</span><br><span class="line"># 设置token失效的时间（单位秒(s)）</span><br><span class="line">http.anti_steal.token_ttl=1800</span><br><span class="line"># 密钥，请注意它跟客户端配置文件中fastdfs.http_secret_key保持一致</span><br><span class="line">http.anti_steal.secret_key=FastDFS1234567890</span><br><span class="line"># token检查失败返回的信息</span><br><span class="line">http.anti_steal.token_check_fail=/home/soft/fastdfs-5.11/conf/anti-steal.jpg</span><br></pre></td></tr></tbody></table></figure></div>
<p>配置完成后，需要重启nginx，使用命令如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/./nginx -s stop</span><br><span class="line">/usr/local/nginx/sbin/./nginx</span><br></pre></td></tr></tbody></table></figure></div>
<p><strong>第二步，配置客户端。</strong>在项目的<code>fastdfs-client.properties</code>配置文件中修改如下两行配置为：(修改后的结果)</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 开启token防盗链</span><br><span class="line">fastdfs.http_anti_steal_token = true</span><br><span class="line"># 密钥，注意必须和/etc/fdfs/http.conf文件中的http.anti_steal.secret_key值保持一致</span><br><span class="line">fastdfs.http_secret_key = FastDFS1234567890</span><br></pre></td></tr></tbody></table></figure></div>
<p><strong>第三步，客户端生成token。</strong>接下来定义一个方法，该方法用于返回访问文件的URL，请注意该URL中不仅包含了<code>file_id</code>，还有生成的token以及unix时间戳，所以返回的URL其实是token和时间戳拼接后的链接，如<code>http://file.envy.com:81/group1/M00/00/00/wKgChF7cTG6AO5ciAABkkg-s-zw858.jpg?token=ec5490454dfba1642657f69e382fcc1e&ts=1591512050</code>。方法中的代码为：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public static String getURL(String filePath,String httpSecretKey){</span><br><span class="line">    //生成时间戳,单位秒</span><br><span class="line">    int ts = (int)Instant.now().getEpochSecond();</span><br><span class="line">    //获得token</span><br><span class="line">    String token = "";</span><br><span class="line">    try {</span><br><span class="line">        token = ProtoCommon.getToken(filePath,ts,httpSecretKey);</span><br><span class="line">    } catch (UnsupportedEncodingException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } catch (NoSuchAlgorithmException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } catch (MyException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    StringBuilder stringBuilder = new StringBuilder();</span><br><span class="line">    stringBuilder.append("http://file.envy.com:81/group1/").append(filePath)</span><br><span class="line">            .append("?token=").append(token)</span><br><span class="line">            .append("&ts=").append(ts);</span><br><span class="line">    return stringBuilder.toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>请注意filePath是文件的file_id，也就是文件上传成功后的返回值；<code>httpSecretKey</code>就是开发者在<code>fastdfs-client.properties</code>配置文件中<code>fastdfs.http_secret_key</code>的设置的值，最后在main方法中运行该方法：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args){</span><br><span class="line">    String restlut = getURL("M00/00/00/wKgChF7cTG6AO5ciAABkkg-s-zw858.jpg","FastDFS1234567890");</span><br><span class="line">    System.out.println(restlut);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>可以看到输出结果为：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://file.envy.com:81/group1/M00/00/00/wKgChF7cTG6AO5ciAABkkg-s-zw858.jpg?token=ec5490454dfba1642657f69e382fcc1e&ts=1591512050</span><br></pre></td></tr></tbody></table></figure></div>
<p>接着打开浏览器，在地址栏中输入上述返回结果，访问它即可查看到该照片：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-ecb7fb4a9db2d8ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://upload-images.jianshu.io/upload_images/8964398-ecb7fb4a9db2d8ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload mediumZoom" title></a></p>
<p>其实如果文件的安全级别较高，建议直接通过<code>fastdfs-client</code>提供的API去访问，而不是使用配置Nginx通过http请求来进行访问的方式。这里配置的Nginx主要用于快速访问存储服务器的文件，如果还要需要权限验证，则要求客户端生成token，并携带token和时间戳去访问，这样看来其实完全没有必要，倒不如使用Spring Security来加密API这种显得更为可取。</p>
<p>看到这里是不是觉得非常不方便，后期有空的时候，笔者会对其进行一个封装，并对外提供访问的API接口。</p>
<p>后续会介绍FastDFS如何搭建集群以及SpringBoot如何整合FastDFS集群。</p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">余思</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://envyzhan.top/2019/09/28/springboot-22-union-one-fastDFS/">http://envyzhan.top/2019/09/28/springboot-22-union-one-fastDFS/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://envyzhan.top">余思博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/springboot/">springboot    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/11/01/spring-cloud-eureka-1-introdution/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Spring Cloud Eureka介绍</span></div></a></div><div class="next-post pull_right"><a href="/2019/09/25/springboot-21-project-build-and-development/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>项目构建与部署</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/09/25/springboot-21-project-build-and-development/" title="项目构建与部署"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">项目构建与部署</div></div></a></div><div class="relatedPosts_item"><a href="/2019/09/22/springboot-20-application-monitor/" title="应用监控"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">应用监控</div></div></a></div><div class="relatedPosts_item"><a href="/2019/09/19/springboot-19-usual-development-for-enterprise-two/" title="企业开发常用功能（下）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">企业开发常用功能（下）</div></div></a></div><div class="relatedPosts_item"><a href="/2019/09/16/springboot-18-usual-development-for-enterprise-one/" title="企业开发常用功能（上）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">企业开发常用功能（上）</div></div></a></div><div class="relatedPosts_item"><a href="/2019/09/13/springboot-17-message-service/" title="消息服务"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">消息服务</div></div></a></div><div class="relatedPosts_item"><a href="/2019/09/10/springboot-16-union-websocket/" title="整合WebSocket"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">整合WebSocket</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '9996b44b488f2fc52124',
  clientSecret: '6bec0f8e9c032eeae6211a5d4cffa3c97e2d4a64',
  repo: 'blogcomment',
  owner: 'Envythink',
  admin: 'Envythink',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
}</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">Copyright &copy;2017-2021 余思博客, 版权所有</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/fireworks.js"></script><script src="/js/tw_cn.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>