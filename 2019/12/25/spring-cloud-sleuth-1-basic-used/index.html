<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Sleuth基础使用 | 余思博客</title><meta name="description" content="Sleuth基础使用"><meta name="keywords" content="springcloud"><meta name="author" content="余思"><meta name="copyright" content="余思"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Sleuth基础使用"><meta name="twitter:description" content="Sleuth基础使用"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="Sleuth基础使用"><meta property="og:url" content="http://envyzhan.top/2019/12/25/spring-cloud-sleuth-1-basic-used/"><meta property="og:site_name" content="余思博客"><meta property="og:description" content="Sleuth基础使用"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://envyzhan.top/2019/12/25/spring-cloud-sleuth-1-basic-used/"><link rel="prev" title="Sleuth整合ELK" href="http://envyzhan.top/2019/12/26/spring-cloud-sleuth-2-integrating-elk/"><link rel="next" title="Stream基础使用" href="http://envyzhan.top/2019/12/24/spring-cloud-stream-1-basic-used/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://envythink.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: 余思","link":"链接: http://envyzhan.top/2019/12/25/spring-cloud-sleuth-1-basic-used/","source":"来源: 余思博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">余思博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-html5" aria-hidden="true"></i><span> 前端</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> Java</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 运维</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 中间件</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page" href="/categories/nginx/"><i class="fa-fw fa fa-location-arrow"></i><span> Nginx</span></a></li><li><a class="site-page" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bell" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 数据结构</span></a></li><li><a class="site-page" href="/categories/algorithm/"><i class="fa-fw fa fa-plane"></i><span> 算法建模</span></a></li><li><a class="site-page" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-address-book" aria-hidden="true"></i><span> 生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">213</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">15</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-html5" aria-hidden="true"></i><span> 前端</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/html/"><i class="fa-fw fa fa-cog"></i><span> HTML/CSS</span></a></li><li><a class="site-page" href="/categories/javascript/"><i class="fa-fw fa fa-cogs"></i><span> JavaScript</span></a></li><li><a class="site-page" href="/categories/vuejs/"><i class="fa-fw fa fa-certificate"></i><span> Vue.js</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> Java</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/java/"><i class="fa-fw fa fa-book"></i><span> Java</span></a></li><li><a class="site-page" href="/categories/ssm/"><i class="fa-fw fa fa-cube"></i><span> SSM</span></a></li><li><a class="site-page" href="/categories/springboot/"><i class="fa-fw fa fa-cubes"></i><span> SpringBoot</span></a></li><li><a class="site-page" href="/categories/springcloud/"><i class="fa-fw fa fa-cloud"></i><span> SpringCloud</span></a></li><li><a class="site-page" href="/categories/springsecurity/"><i class="fa-fw fa fa-bullseye"></i><span> SpringSecurity</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 运维</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/pythonbase/"><i class="fa-fw fa fa-book"></i><span> Python</span></a></li><li><a class="site-page" href="/categories/go/"><i class="fa-fw fa fa-google-plus"></i><span> Golang</span></a></li><li><a class="site-page" href="/categories/devops/"><i class="fa-fw fa fa-road"></i><span> DevOps</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 中间件</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/mysql/"><i class="fa-fw fa fa-database"></i><span> MySQL</span></a></li><li><a class="site-page" href="/categories/nginx/"><i class="fa-fw fa fa-location-arrow"></i><span> Nginx</span></a></li><li><a class="site-page" href="/categories/redis/"><i class="fa-fw fa fa-random"></i><span> Redis</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bell" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/datastructs/"><i class="fa-fw fa fa-plug"></i><span> 数据结构</span></a></li><li><a class="site-page" href="/categories/algorithm/"><i class="fa-fw fa fa-plane"></i><span> 算法建模</span></a></li><li><a class="site-page" href="/categories/tools/"><i class="fa-fw fa fa-hourglass"></i><span> 实用工具</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-address-book" aria-hidden="true"></i><span> 生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/onenote/"><i class="fa-fw fa fa-laptop"></i><span> 个人随笔</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#写在前面"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">写在前面</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#入门演示"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">入门演示</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#项目准备"><span class="toc_mobile_items-number">2.0.1.</span> <span class="toc_mobile_items-text">项目准备</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#跟踪实现"><span class="toc_mobile_items-number">2.0.2.</span> <span class="toc_mobile_items-text">跟踪实现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#跟踪原理"><span class="toc_mobile_items-number">2.0.3.</span> <span class="toc_mobile_items-text">跟踪原理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#抽样收集"><span class="toc_mobile_items-number">2.0.4.</span> <span class="toc_mobile_items-text">抽样收集</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#写在前面"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#入门演示"><span class="toc-number">2.</span> <span class="toc-text">入门演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目准备"><span class="toc-number">2.0.1.</span> <span class="toc-text">项目准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跟踪实现"><span class="toc-number">2.0.2.</span> <span class="toc-text">跟踪实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跟踪原理"><span class="toc-number">2.0.3.</span> <span class="toc-text">跟踪原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#抽样收集"><span class="toc-number">2.0.4.</span> <span class="toc-text">抽样收集</span></a></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Sleuth基础使用</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-12-25</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/springcloud/">springcloud</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">3.9k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 13 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2019/12/25/spring-cloud-sleuth-1-basic-used/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>通过前面的学习，我们已经可以搭起一个基础的微服务架构系统用于实现业务需求，但是随着业务的发展，系统的规模变得越来越大，各服务间的调用关系也变得错综复杂。一般来说，客户端发起一个请求后，在后端系统中会经过多个不同的微服务调用来协同产生最后的请求结果。在复杂的微服务架构系统中，几乎每一个前端请求都会形成一条复杂的分布式服务调用链路，在每条链路中任何一个依赖服务出现延迟过高或者错误的时候，都有可能导致请求最后的失败。此时对于每一个请求，全链路调用的跟踪就显得尤为重要，通过对请求的调用跟踪可以帮助我们快速发现错误根源以及监控分析每条请求链路上的性能瓶颈等。</p>
<p>对于分布式服务的跟踪问题，Spring Cloud Sleuth提供了一套完整的解决方案，接下来就学习如何使用Spring Cloud Sleuth。</p>
<h1 id="入门演示"><a href="#入门演示" class="headerlink" title="入门演示"></a>入门演示</h1><h3 id="项目准备"><a href="#项目准备" class="headerlink" title="项目准备"></a>项目准备</h3><p>为了后续学习Spring Cloud Sleuth，这里需要先做一些准备工作，来构建一些基础的设施和应用。</p>
<p>第一步，构建一个服务注册中心当然可以使用之前的eureka-server项目；</p>
<p>第二步，构建两个微服务应用，名称为trace-one和trace-two。其中trace-one项目需要提供一个REST风格的接口<code>/trace-one</code>，然后调用该接口后需要触发对trace-two项目的调用。</p>
<p>创建trace-one项目的步骤如下：</p>
<p>（1）新建一个普通的SpringBoot工程，名称为trace-one，注意使用默认的依赖。</p>
<p>（2）添加项目依赖。Spring Boot工程创建完成后，修改pom.xml文件，添加如下依赖：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><properties></properties></span><br><span class="line">    <project.build.sourceencoding>UTF-8</project.build.sourceencoding></span><br><span class="line">    <project.reporting.outputencoding>UTF-8</project.reporting.outputencoding></span><br><span class="line">    <java.version>1.8</java.version></span><br><span class="line">    <spring-cloud.version>Hoxton.SR7</spring-cloud.version></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><dependencies></dependencies></span><br><span class="line">    <dependency></dependency></span><br><span class="line">        <groupid>org.springframework.boot</groupid></span><br><span class="line">        <artifactid>spring-boot-starter-web</artifactid></span><br><span class="line">    </span><br><span class="line">    <dependency></dependency></span><br><span class="line">        <groupid>org.springframework.cloud</groupid></span><br><span class="line">        <artifactid>spring-cloud-starter-netflix-eureka-client</artifactid></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <dependency></dependency></span><br><span class="line">        <groupid>org.springframework.cloud</groupid></span><br><span class="line">        <artifactid>spring-cloud-starter-netflix-hystrix</artifactid></span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>
<p>（3）在trace-one项目入口类上添加开启服务注册发现注解<code>@EnableDiscoveryClient</code>，并提供一个生成RestTemplate对象的方法，注意该方法上面必须使用<code>@LoadBalanced</code>注解，相应的代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class TraceOneApplication {</span><br><span class="line">    @Bean</span><br><span class="line">    @LoadBalanced</span><br><span class="line">    RestTemplate restTemplate(){</span><br><span class="line">        return new RestTemplate();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) {</span><br><span class="line">        SpringApplication.run(TraceOneApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>（4）在trace-one项目目录下新建controller包，并在里面新建HelloController类，它需要提供一个REST风格的接口<code>/trace-one</code>，然后调用该接口后需要触发对trace-two项目的调用。这里没有使用Feign而是直接使用Ribbon，其目的就是让大家对这个过程有较为深刻的认识。既然需要调用trace-two项目，那么就需要通过服务注册中心来调用，可以使用RestTemplate对象来进行操作，相应的代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class HelloController {</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(HelloController.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = "/trace-one")</span><br><span class="line">    public String traceOne(){</span><br><span class="line">        logger.info("********正在调用traceOne******");</span><br><span class="line">        return restTemplate.getForEntity("http://trace-two/trace-two",String.class).getBody();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>（5）修改trace-one项目的application.properties配置文件，添加服务注册中心地址，项目名称和端口号等信息：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 应用名称</span><br><span class="line">spring.application.name=trace-one</span><br><span class="line"># 端口号</span><br><span class="line">server.port=5001</span><br><span class="line"># 服务注册中心地址</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka/</span><br></pre></td></tr></tbody></table></figure></div>
<p>这样关于trace-one项目的创建工作就完成了，接下来开始进行trace-two项目的创建工作。</p>
<hr>
<p>trace-two项目比trace-one项目的创建流程更简单些，因为它不需要调用前者，相应的步骤如下：<br>（1）新建一个普通的SpringBoot工程，名称为trace-two，注意使用默认的依赖。<br>（2）添加项目依赖。Spring Boot工程创建完成后，修改pom.xml文件，添加如下依赖：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><properties></properties></span><br><span class="line">    <project.build.sourceencoding>UTF-8</project.build.sourceencoding></span><br><span class="line">    <project.reporting.outputencoding>UTF-8</project.reporting.outputencoding></span><br><span class="line">    <java.version>1.8</java.version></span><br><span class="line">    <spring-cloud.version>Hoxton.SR7</spring-cloud.version></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><dependencies></dependencies></span><br><span class="line">    <dependency></dependency></span><br><span class="line">        <groupid>org.springframework.boot</groupid></span><br><span class="line">        <artifactid>spring-boot-starter-web</artifactid></span><br><span class="line">    </span><br><span class="line">    <dependency></dependency></span><br><span class="line">        <groupid>org.springframework.cloud</groupid></span><br><span class="line">        <artifactid>spring-cloud-starter-netflix-eureka-client</artifactid></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <dependency></dependency></span><br><span class="line">        <groupid>org.springframework.cloud</groupid></span><br><span class="line">        <artifactid>spring-cloud-starter-netflix-hystrix</artifactid></span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>
<p>（3）在trace-two项目入口类上添加开启服务注册发现注解<code>@EnableDiscoveryClient</code>，相应的代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class TraceTwoApplication {</span><br><span class="line">    public static void main(String[] args) { </span><br><span class="line">        SpringApplication.run(TraceTwoApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>（4）在trace-two项目目录下新建controller包，并在里面新建WorldController类，它需要提供一个REST风格的接口<code>/trace-two</code>，然后/<code>trace-one</code>接口被调用后，需要触发对<code>/trace-two</code>接口调用，相应的代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class WorldController {</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(WorldController.class);</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = "/trace-two")</span><br><span class="line">    public String traceTwo(){</span><br><span class="line">        logger.info("********正在调用traceTwo******");</span><br><span class="line">        return "This is the trace two!";</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>（5）修改trace-two项目的application.properties配置文件，添加服务注册中心地址，项目名称和端口号等信息：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 应用名称</span><br><span class="line">spring.application.name=trace-two</span><br><span class="line"># 端口号</span><br><span class="line">server.port=5002</span><br><span class="line"># 服务注册中心地址</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka/</span><br></pre></td></tr></tbody></table></figure></div>
<p>这样关于trace-two项目的创建工作就完成了。</p>
<p>第三步，启动测试。将eureka-server项目，trace-one项目，trace-two项目都启动起来，然后通过使用POSTMAN或者curl工具来完成对trace-one项目的<code>/trace-one</code>接口的测试，或者直接在浏览器地址栏中输入<code>http://localhost:5001/trace-one</code>连接得到返回值<code>"This is the trace two!";</code>，如下所示：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-c22a51a7ed397c61.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title class="mediumZoom lazyload" data-src="https://upload-images.jianshu.io/upload_images/8964398-c22a51a7ed397c61.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></a></p>
<p>同时可以得到trace-one项目和trace-two项目的控制台都会输出调用相应方法的信息。</p>
<h3 id="跟踪实现"><a href="#跟踪实现" class="headerlink" title="跟踪实现"></a>跟踪实现</h3><p>前面项目启动正常之后，接下来开始改造项目，使其拥有服务跟踪功能。通过Spring Cloud Sleuth的封装，我们为应用增加服务跟踪功能非常简单，只需在项目的pom.xml文件中增加<code>spring-cloud-starter-sleuth</code>依赖，相应的代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><dependency></dependency></span><br><span class="line">    <groupid>org.springframework.cloud</groupid></span><br><span class="line">    <artifactid>spring-cloud-starter-sleuth</artifactid></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>
<p>既然这样就在trace-one项目和trace-two项目的pom.xml文件中添加<code>spring-cloud-starter-sleuth</code>依赖，然后重启上述三个项目，在浏览器地址栏中输入<code>http://localhost:5001/trace-one</code>，接着观察trace-one项目的控制台，可以得到如下所示的信息：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-9392f2d2a469b671.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title class="mediumZoom lazyload" data-src="https://upload-images.jianshu.io/upload_images/8964398-9392f2d2a469b671.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></a></p>
<p>可以注意到图中圈红的黄色内容是添加Sleuth依赖之后才有的，形如<code>[trace-one,31406450af9d124c,533509b73bc9fa9b,true]</code>的日志信息，而这些元素正是实现分布式服务跟踪的重要组成部分，接下来对上述日志信息进行分析：</p>
<ul>
<li>第一个值<code>trace-one</code>，它记录了应用的名称，也就是application.properties配置文件中的<code>spring.application.name</code>参数的值。</li>
<li>第二个值<code>31406450af9d124c</code>，它是Spring Cloud Sleuth生成的一个ID，称为Trace ID，它用来标识一条请求链路。<strong>请注意，一条请求链路中包含一个Trace ID，多个Span ID。</strong></li>
<li>第三个值<code>533509b73bc9fa9b</code>，它是Spring Cloud Sleuth生成的另一个ID，称为Span ID，它表示一个基本的工作单元，如发送一个HTTP请求。</li>
<li>第四个值<code>true</code>，表示是否需要将该信息输出到Zipkin等服务，用于收集和展示。</li>
</ul>
<p>接下来查看一下trace-two项目的控制台输出情况：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-d6d4c06b4e77a5f5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title class="mediumZoom lazyload" data-src="https://upload-images.jianshu.io/upload_images/8964398-d6d4c06b4e77a5f5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></a></p>
<p>其实可以发现上面介绍的四个值中的Trace ID和Span ID，它们是Spring Cloud Sleuth实现分布式服务跟踪的核心。在一次服务请求链路的调用过程中，会保持并传递同一个Trace ID，进而将整个分布于不同微服务进程中的请求跟踪信息串联起来。上面的输出信息可以说明，trace-one和trace-two同属于一个前端服务请求来源，因此它们的Trace ID是相同的，处于同一条请求链路中。</p>
<h3 id="跟踪原理"><a href="#跟踪原理" class="headerlink" title="跟踪原理"></a>跟踪原理</h3><p>接下来开始学习分布式系统中的服务跟踪原理，其实这个原理非常简单就是借助于前面所介绍的2个ID：Trace ID和Span ID。</p>
<p>为了实现请求跟踪，当请求发送到分布式系统的入口端点时，只需要服务跟踪框架为该请求创建一个唯一的跟踪标识，同时在分布式系统内部流转的时候，框架始终保持传递该唯一标识，直到返回给请求方为止，而这个标识就是Trace ID。这样通过Trace ID的记录，我们就能将所有请求过程的日志关联起来，这就完成了全过程的跟踪，但是当我们还需要查看各个服务处理请求的详细时间呢？此时可以使用Span ID。</p>
<p>为了统计各处理单元的时间延迟，这就要求当请求到达各个服务组件时，或是处理逻辑到达某个状态时，也通过一个唯一的标识来标识它的开始，具体过程以及结束，而这个标识就是Span ID。对于每个Span ID来说，它必须有开始和结束这两个节点，通过记录开始Span和结束Span的时间戳，开发者就可以统计出该Span的时间延迟，当然除了时间戳记录之外，它还可以包含一些其他的元数据，如事件名称、请求信息等。</p>
<p>前面我们在Spring Boot工程中通过引入<code>spring-cloud-starter-sleuth</code>依赖后，它就会自动为当前应用构建起各通信通道的跟踪机制，如以下几种：（1）通过诸如RabbitMQ和Kafka（或者其他任何Spring Cloud Stream绑定器实现的消息中间件）等消息中间件传递的请求；（2）通过Zuul代理传递的请求；（3）通过使用RestTemplate发起的请求。这样就实现了日志级别的跟踪信息。</p>
<p>在前面的入门demo中，我们设置了trace-one对trace-two发起的请求是通过RestTemplate来实现的，因此Spring Cloud Sleuth组件会对该请求进行跟踪处理。实际上在请求发送到trace-two之前，Sleuth会在该请求的Header中增加实现跟踪需要的重要信息，那么你可能要问了，为什么我们之前没看到呢？那是因为你没将那些信息进行输出，下面列举5个用的较多的属性：<br>（1）<code>X-B3-TraceId</code>：一条请求链路（Trace）的唯一标识，必需值；<br>（2）<code>X-B3-SpanId</code>：一个工作单元（Span）的唯一标识，必需值；<br>（3）<code>X-B3-ParentSpanId</code>：标识当前工作单元所属的上一个工作单元，Root Span（请求链路的第一个工作单元）的该值为空；<br>（4）<code>X-B3-Sampled</code>：是否被抽样输出的标志，1表示需要被输出，0表示不需要被输出；<br>（5）<code>X-Span-Name</code>：工作单元的名称。</p>
<p>举个例子，我们尝试输出trace-two项目的TraceId和SpanId信息，此时需要的操作如下：</p>
<p>第一步，在trace-two项目的application.properties配置文件中添加如下信息：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 设置SpringMVC的请求分发日志级别为DEBUG级别，以便看到更多的跟踪信息</span><br><span class="line">logging.level.org.springframework.web.servlet.DispatcherServlet=DEBUG</span><br></pre></td></tr></tbody></table></figure></div>
<p>第二步，修改trace-two项目WorldController类的traceTwo方法，用于从当前请求中获取TraceId和SpanId信息，相应的代码如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class WorldController {</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(WorldController.class);</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = "/trace-two")</span><br><span class="line">    public String traceTwo(HttpServletRequest request){</span><br><span class="line">        logger.info("********正在调用traceTwo******");</span><br><span class="line">        logger.info("TraceId={}, SpanId={} ",request.getHeader("X-B3-TraceId"),request.getHeader("X-B3-SpanId"));</span><br><span class="line">        return "This is the trace two!";</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>第三步，启动测试。将eureka-server项目，trace-one项目，trace-two项目都启动起来，然后通过使用POSTMAN或者curl工具来完成对trace-one项目的/trace-one接口的测试，或者直接在浏览器地址栏中输入<code>http://localhost:5001/trace-one</code>链接，然后观察trace-two项目的控制台输出信息，如下所示：</p>
<p><a href="https://upload-images.jianshu.io/upload_images/8964398-33a5c1b3b9c3b774.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title class="mediumZoom lazyload" data-src="https://upload-images.jianshu.io/upload_images/8964398-33a5c1b3b9c3b774.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></a></p>
<p>这说明我们获取TraceId和SpanId信息的功能就实现了。</p>
<h3 id="抽样收集"><a href="#抽样收集" class="headerlink" title="抽样收集"></a>抽样收集</h3><p>通过TraceId和SpanId已经实现了对分布式系统中的请求跟踪，而记录的跟踪信息最终会被分析系统收集起来，并用于实现对分布式系统的监控和分析功能，如预警延迟过长的请求链路、查询请求链路的调用明细等。现在有一个问题，就是分析系统在收集跟踪信息的时候，收集多少跟踪信息才合适呢？理论上是收集的跟踪信息越多就越能反映出系统的实际运行情况，以便给出较为精准的预警和分析，但是在高并发的分布式系统运行时，大量的请求调用会产生海量的跟踪日志信息，收集过多的跟踪信息也将对整个分布式系统的性能造成一定的影响，同时保存大量的日志信息也需要大量的存储开销。鉴于此，Sleuth采用抽象收集的方式来为跟踪信息打上收集标记，也就是之前我们在日志信息中看到的第4个布尔类型的值，它代表了该信息是否需要被后续的跟踪信息收集器获取和存储。</p>
<p>在Sleuth中，抽样收集策略是通过Sampler抽象类来实现的，如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public abstract class Sampler {</span><br><span class="line">    public static final Sampler ALWAYS_SAMPLE = new Sampler() {</span><br><span class="line">        public boolean isSampled(long traceId) {</span><br><span class="line">            return true;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        public String toString() {</span><br><span class="line">            return "AlwaysSample";</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    public static final Sampler NEVER_SAMPLE = new Sampler() {</span><br><span class="line">        public boolean isSampled(long traceId) {</span><br><span class="line">            return false;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        public String toString() {</span><br><span class="line">            return "NeverSample";</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    public Sampler() {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public abstract boolean isSampled(long var1);</span><br><span class="line"></span><br><span class="line">    public static Sampler create(float probability) {</span><br><span class="line">        return CountingSampler.create(probability);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>可以看到里面有一个名为isSampled的抽象方法，Spring Cloud Sleuth组件会在产生跟踪信息的时候调用它来为跟踪信息生成是否需要被收集的标志。<strong>请注意，即使isSampled方法返回了false，它只是代表该跟踪信息不被输出到后续对接的远程分析系统（如Zipkin中），但是对于请求的跟踪活动依然会进行，所以我们在日志中还是能看到收集标识为false的记录。</strong></p>
<p>在默认情况下，Sleuth会使用PercentageBasedSampler实现的抽象策略，以请求百分比的方式来配置和收集跟踪信息。开发者可以在application.properties配置文件中通过使用下面的参数来设置百分比，它的默认值是10，表示收集10%的请求跟踪信息：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 收集10%的请求跟踪信息</span><br><span class="line">spring.sleuth.sampler.rate=10</span><br></pre></td></tr></tbody></table></figure></div>
<p>一般来说在开发调试期间通常会将其设置为100，表示收集全部跟踪信息并输出到远程仓库。当然了开发者也可以通过代码来实现相同的配置，只需创建AlwaysSampler的Bean（它实现的isSampled方法始终返回true）来覆盖默认的PercentageBasedSampler策略即可：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public AlwaysSampler defaultSampler(){</span><br><span class="line">  return new AlwaysSampler();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>在实际使用时，通过与Span对象中存储信息的配合，我们可以根据实际情况作出更符合需求的抽样策略，如实现一个仅仅包含指定Tag的抽样策略：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class TagSampler extends Sampler{</span><br><span class="line">  private String tag;</span><br><span class="line">  public TagSampler(String tag){</span><br><span class="line">    this.tag =tag;</span><br><span class="line">  };</span><br><span class="line">  public boolean isSampled(Span span) {</span><br><span class="line">            return span.tags().get(tag)!=null;</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>由于跟踪日志信息数据的价值往往仅在最近的一段时间内非常有效，因此在设计抽样策略时，主要考虑在不对系统造成明显性能影响的情况下，以在日志保留时间窗内充分利用存储空间的原则来实现抽样策略。</p>
<p>这样关于Spring Cloud Sleuth分布式服务跟踪组件的基础使用就学习到这里，后续开始学习如何与ELK整合等知识。</p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">余思</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://envyzhan.top/2019/12/25/spring-cloud-sleuth-1-basic-used/">http://envyzhan.top/2019/12/25/spring-cloud-sleuth-1-basic-used/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://envyzhan.top">余思博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/springcloud/">springcloud    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/12/26/spring-cloud-sleuth-2-integrating-elk/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Sleuth整合ELK</span></div></a></div><div class="next-post pull_right"><a href="/2019/12/24/spring-cloud-stream-1-basic-used/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Stream基础使用</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/12/29/spring-cloud-sleuth-4-data-storage/" title="Sleuth数据存储"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Sleuth数据存储</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/28/spring-cloud-sleuth-3-integrating-zipkin/" title="Sleuth整合Zipkin"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Sleuth整合Zipkin</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/26/spring-cloud-sleuth-2-integrating-elk/" title="Sleuth整合ELK"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Sleuth整合ELK</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/24/spring-cloud-stream-1-basic-used/" title="Stream基础使用"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Stream基础使用</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/23/spring-cloud-bus-3-integrating-kafka/" title="Bus整合Kafka"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Bus整合Kafka</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/22/spring-cloud-bus-2-integrating-rabbitmq/" title="Bus整合RabbitMQ"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-01</div><div class="relatedPosts_title">Bus整合RabbitMQ</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '9996b44b488f2fc52124',
  clientSecret: '6bec0f8e9c032eeae6211a5d4cffa3c97e2d4a64',
  repo: 'blogcomment',
  owner: 'Envythink',
  admin: 'Envythink',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
}</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">Copyright &copy;2017-2021 余思博客, 版权所有</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/fireworks.js"></script><script src="/js/tw_cn.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>